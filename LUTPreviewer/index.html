<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LUT Applicator</title>
  <style>
    :root {
      --bg: #191919;
      --card-bg: #1F1F1F;
      --hover: #323232;
      --outline: #323232;
      --accent: #87A9FF;
      --text-primary: #D4D4D4;
      --text-secondary: #8C8C8C;
      --radius: 8px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text-primary);
      font-family: sans-serif;
      padding: 24px 16px;
    }

    /* ===== MAIN CONTAINER ===== */
    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* ===== UPLOAD SECTION ===== */
    .upload-section {
      background: var(--card-bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 24px 16px;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .upload-grid {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 640px) {
      .upload-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .upload-box {
      background: var(--bg);
      border: 2px dashed var(--outline);
      border-radius: var(--radius);
      padding: 24px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-box:hover {
      border-color: var(--accent);
      background: var(--hover);
    }

    .upload-box.has-file {
      border-color: var(--accent);
      border-style: solid;
    }

    .upload-label {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      display: block;
    }

    .upload-info {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .file-name {
      font-size: 12px;
      color: var(--accent);
      margin-top: 8px;
      word-break: break-word;
    }

    input[type="file"] {
      display: none;
    }

    /* ===== PREVIEW SECTION ===== */
    .preview-section {
      background: var(--card-bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 24px 16px;
      margin-bottom: 16px;
    }

    .preview-container {
      background: var(--bg);
      border-radius: var(--radius);
      overflow: hidden;
      position: relative;
    }

    .preview-placeholder {
      padding: 80px 16px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
    }

    #previewCanvas {
      display: block;
      max-width: 100%;
      height: auto;
      margin: 0 auto;
    }

    /* ===== SLIDER SECTION ===== */
    .slider-section {
      margin-top: 16px;
      display: none;
    }

    .slider-section.active {
      display: block;
    }

    .slider-label {
      font-size: 14px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .slider-value {
      color: var(--accent);
      font-weight: bold;
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      background: var(--bg);
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      transition: transform 0.2s ease;
    }

    input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.2);
    }

    /* ===== BUTTON ===== */
    .btn {
      position: relative;
      padding: 10px 16px;
      border-radius: var(--radius);
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid rgba(255,255,255,0.06);
      cursor: pointer;
      overflow: hidden;
      font-size: 14px;
      width: 100%;
      margin-top: 16px;
      transition: background 0.3s ease;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn:not(:disabled)::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 75%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
      transform: skewX(-25deg);
      transition: left 0.7s ease-in-out;
    }

    .btn:not(:disabled):hover::before {
      left: 125%;
    }

    .btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(135,169,255,0.12);
    }

    /* ===== STATUS MESSAGE ===== */
    .status-message {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 12px;
      padding: 8px;
      border-radius: var(--radius);
      background: var(--bg);
      display: none;
    }

    .status-message.show {
      display: block;
    }

    .status-message.error {
      color: #ff6b6b;
    }

    .status-message.success {
      color: #51cf66;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ===== UPLOAD SECTION ===== -->
    <div class="upload-section">
      <div class="section-title">Upload Files</div>
      <div class="upload-grid">
        <!-- IMAGE UPLOAD -->
        <div class="upload-box" id="imageUploadBox" onclick="document.getElementById('imageInput').click()">
          <div class="upload-label">ðŸ“· Select Image</div>
          <div class="upload-info">JPG, PNG, WebP</div>
          <div class="file-name" id="imageName"></div>
        </div>

        <!-- LUT UPLOAD -->
        <div class="upload-box" id="lutUploadBox" onclick="document.getElementById('lutInput').click()">
          <div class="upload-label">ðŸŽ¨ Select LUT File</div>
          <div class="upload-info">.cube format</div>
          <div class="file-name" id="lutName"></div>
        </div>
      </div>

      <input type="file" id="imageInput" accept="image/*">
      <input type="file" id="lutInput" accept=".cube">
    </div>

    <!-- ===== PREVIEW SECTION ===== -->
    <div class="preview-section">
      <div class="section-title">Preview</div>
      
      <div class="preview-container">
        <div class="preview-placeholder" id="placeholder">
          Upload an image and LUT file to see the preview
        </div>
        <canvas id="previewCanvas" style="display: none;"></canvas>
      </div>

      <!-- ===== INTENSITY SLIDER ===== -->
      <div class="slider-section" id="sliderSection">
        <div class="slider-label">
          <span>LUT Intensity</span>
          <span class="slider-value" id="intensityValue">100%</span>
        </div>
        <input type="range" id="intensitySlider" min="0" max="100" value="100">
      </div>

      <button class="btn" id="downloadBtn" disabled>Download Image</button>
      
      <div class="status-message" id="statusMessage"></div>
    </div>
  </div>

  <script>
    // ===== GLOBAL VARIABLES =====
    let originalImage = null;
    let lutData = null;
    let lutSize = 0;
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    // ===== IMAGE UPLOAD HANDLER =====
    document.getElementById('imageInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          originalImage = img;
          document.getElementById('imageName').textContent = file.name;
          document.getElementById('imageUploadBox').classList.add('has-file');
          applyLUT();
          scheduleHeightCheck();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // ===== LUT UPLOAD HANDLER =====
    document.getElementById('lutInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const result = parseCubeLUT(event.target.result);
          lutData = result.data;
          lutSize = result.size;
          document.getElementById('lutName').textContent = file.name;
          document.getElementById('lutUploadBox').classList.add('has-file');
          showStatus('LUT file loaded successfully', 'success');
          applyLUT();
          scheduleHeightCheck();
        } catch (error) {
          showStatus('Error parsing LUT file: ' + error.message, 'error');
          lutData = null;
          lutSize = 0;
        }
      };
      reader.readAsText(file);
    });

    // ===== PARSE .CUBE LUT FILE =====
    function parseCubeLUT(text) {
      const lines = text.split('\n');
      let size = 0;
      const data = [];

      for (let line of lines) {
        line = line.trim();
        
        // Skip comments and empty lines
        if (line.startsWith('#') || line.startsWith('TITLE') || line === '') continue;
        
        // Get LUT size
        if (line.startsWith('LUT_3D_SIZE')) {
          size = parseInt(line.split(/\s+/)[1]);
          continue;
        }

        // Skip domain min/max
        if (line.startsWith('DOMAIN_MIN') || line.startsWith('DOMAIN_MAX')) continue;

        // Parse RGB values
        const values = line.split(/\s+/).filter(v => v !== '');
        if (values.length === 3) {
          data.push({
            r: parseFloat(values[0]),
            g: parseFloat(values[1]),
            b: parseFloat(values[2])
          });
        }
      }

      if (size === 0 || data.length === 0) {
        throw new Error('Invalid LUT file format');
      }

      return { data, size };
    }

    // ===== APPLY LUT TO IMAGE =====
    function applyLUT() {
      if (!originalImage || !lutData) {
        return;
      }

      // Set canvas size to image size
      canvas.width = originalImage.width;
      canvas.height = originalImage.height;

      // Draw original image
      ctx.drawImage(originalImage, 0, 0);

      // Get image data
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const pixels = imageData.data;

      // Get intensity
      const intensity = parseInt(document.getElementById('intensitySlider').value) / 100;

      // Apply LUT to each pixel
      for (let i = 0; i < pixels.length; i += 4) {
        const r = pixels[i] / 255;
        const g = pixels[i + 1] / 255;
        const b = pixels[i + 2] / 255;

        // Lookup in LUT
        const newColor = lookupLUT(r, g, b);

        // Blend based on intensity
        pixels[i] = Math.round(pixels[i] + (newColor.r * 255 - pixels[i]) * intensity);
        pixels[i + 1] = Math.round(pixels[i + 1] + (newColor.g * 255 - pixels[i + 1]) * intensity);
        pixels[i + 2] = Math.round(pixels[i + 2] + (newColor.b * 255 - pixels[i + 2]) * intensity);
      }

      // Put modified image data back
      ctx.putImageData(imageData, 0, 0);

      // Show canvas and hide placeholder
      document.getElementById('placeholder').style.display = 'none';
      canvas.style.display = 'block';
      document.getElementById('sliderSection').classList.add('active');
      document.getElementById('downloadBtn').disabled = false;

      scheduleHeightCheck();
    }

    // ===== LOOKUP COLOR IN LUT =====
    function lookupLUT(r, g, b) {
      // Clamp values
      r = Math.max(0, Math.min(1, r));
      g = Math.max(0, Math.min(1, g));
      b = Math.max(0, Math.min(1, b));

      // Calculate position in LUT
      const scale = lutSize - 1;
      const rPos = r * scale;
      const gPos = g * scale;
      const bPos = b * scale;

      // Get integer and fractional parts
      const r0 = Math.floor(rPos);
      const g0 = Math.floor(gPos);
      const b0 = Math.floor(bPos);
      const r1 = Math.min(r0 + 1, scale);
      const g1 = Math.min(g0 + 1, scale);
      const b1 = Math.min(b0 + 1, scale);

      const rFrac = rPos - r0;
      const gFrac = gPos - g0;
      const bFrac = bPos - b0;

      // Trilinear interpolation
      const c000 = lutData[b0 * lutSize * lutSize + g0 * lutSize + r0];
      const c001 = lutData[b0 * lutSize * lutSize + g0 * lutSize + r1];
      const c010 = lutData[b0 * lutSize * lutSize + g1 * lutSize + r0];
      const c011 = lutData[b0 * lutSize * lutSize + g1 * lutSize + r1];
      const c100 = lutData[b1 * lutSize * lutSize + g0 * lutSize + r0];
      const c101 = lutData[b1 * lutSize * lutSize + g0 * lutSize + r1];
      const c110 = lutData[b1 * lutSize * lutSize + g1 * lutSize + r0];
      const c111 = lutData[b1 * lutSize * lutSize + g1 * lutSize + r1];

      const c00 = lerp(c000, c001, rFrac);
      const c01 = lerp(c010, c011, rFrac);
      const c10 = lerp(c100, c101, rFrac);
      const c11 = lerp(c110, c111, rFrac);

      const c0 = lerp(c00, c01, gFrac);
      const c1 = lerp(c10, c11, gFrac);

      return lerp(c0, c1, bFrac);
    }

    // ===== LINEAR INTERPOLATION =====
    function lerp(a, b, t) {
      return {
        r: a.r + (b.r - a.r) * t,
        g: a.g + (b.g - a.g) * t,
        b: a.b + (b.b - a.b) * t
      };
    }

    // ===== INTENSITY SLIDER - UPDATE VALUE ONLY =====
    document.getElementById('intensitySlider').addEventListener('input', function(e) {
      document.getElementById('intensityValue').textContent = e.target.value + '%';
    });

    // ===== INTENSITY SLIDER - APPLY ON RELEASE =====
    document.getElementById('intensitySlider').addEventListener('change', function(e) {
      applyLUT();
    });

    // ===== DOWNLOAD BUTTON =====
    document.getElementById('downloadBtn').addEventListener('click', function() {
      canvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'lut-applied-image.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showStatus('Image downloaded successfully', 'success');
      });
    });

    // ===== STATUS MESSAGE =====
    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = 'status-message show ' + type;
      
      setTimeout(() => {
        statusEl.classList.remove('show');
      }, 3000);
    }

    // ===== FOURTHWALL SCROLLBAR FIX =====
    let lastHeight = 0;
    let resizeTimer;

    function sendHeight() {
      const height = document.body.scrollHeight;
      
      if (height !== lastHeight) {
        lastHeight = height;
        window.parent.postMessage({ frameHeight: height }, '*');
      }
    }

    function scheduleHeightCheck() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(sendHeight, 150);
    }

    window.addEventListener('load', () => {
      setTimeout(sendHeight, 100);
    });

    window.addEventListener('resize', () => {
      scheduleHeightCheck();
    });
    // ===== END OF SCROLLBAR FIX =====
  </script>
</body>
</html>
