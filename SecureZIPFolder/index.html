<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure ZIP Generator - HeroVibes</title>
    <style>
        /* ========== HEROVIBES DESIGN SYSTEM - SCOPED ========== */ 
        .herovibes-zip-tool {
            --primary-bg: #191919;
            --secondary-bg: #1F1F1F;
            --hover-color: #323232;
            --outline-color: #323232;
            --accent-color: #87A9FF;
            --primary-text: #D4D4D4;
            --secondary-text: #8C8C8C;
            --success-color: #4CAF50;
            --error-color: #EF4444;
            --warning-color: #F59E0B;
            font-family: sans-serif;
            color: var(--primary-text);
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
        }

        .herovibes-zip-tool * {
            box-sizing: border-box;
        }

        /* ========== MAIN CONTAINER ========== */
        .herovibes-zip-tool .zip-container {
            background: var(--secondary-bg);
            border: 1px solid var(--outline-color);
            border-radius: 12px;
            padding: 24px 16px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            margin: 0 auto;
        }

        /* ========== PROGRESS TRACKER ========== */
        .herovibes-zip-tool .progress-tracker {
            display: flex;
            justify-content: space-between;
            margin-bottom: 32px;
            position: relative;
            padding: 0 16px;
        }

        .herovibes-zip-tool .progress-line {
            position: absolute;
            top: 15px;
            left: 16px;
            right: 16px;
            height: 2px;
            background: var(--outline-color);
            z-index: 0;
        }

        .herovibes-zip-tool .progress-line-fill {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.4s ease;
        }

        .herovibes-zip-tool .progress-step {
            position: relative;
            z-index: 1;
            text-align: center;
            flex: 1;
        }

        .herovibes-zip-tool .progress-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--secondary-bg);
            border: 2px solid var(--outline-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 12px;
            font-weight: bold;
            color: var(--secondary-text);
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }

        .herovibes-zip-tool .progress-circle::before {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary-bg);
            z-index: -1;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .herovibes-zip-tool .progress-step.active .progress-circle {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background: rgba(135, 169, 255, 0.1);
        }

        .herovibes-zip-tool .progress-step.completed .progress-circle {
            border-color: var(--success-color);
            background: var(--success-color);
            color: white;
        }

        .herovibes-zip-tool .progress-label {
            font-size: 11px;
            color: var(--secondary-text);
            display: none;
        }

        .herovibes-zip-tool .progress-step.active .progress-label,
        .herovibes-zip-tool .progress-step.completed .progress-label {
            color: var(--primary-text);
        }

        /* ========== STEP CONTAINERS ========== */
        .herovibes-zip-tool .step {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .herovibes-zip-tool .step.active {
            display: block;
        }

        @keyframes hvZipFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .herovibes-zip-tool .step {
            animation: hvZipFadeIn 0.4s ease;
        }

        .herovibes-zip-tool .step-header {
            margin-bottom: 20px;
        }

        .herovibes-zip-tool .step-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-text);
            margin-bottom: 6px;
        }

        .herovibes-zip-tool .step-description {
            font-size: 12px;
            color: var(--secondary-text);
            line-height: 1.5;
        }

        /* ========== FILE UPLOAD SECTION ========== */
        .herovibes-zip-tool .drop-zone {
            border: 2px dashed var(--outline-color);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--primary-bg);
            margin-bottom: 16px;
            width: 100%;
            display: block;
        }

        .herovibes-zip-tool .drop-zone:hover {
            border-color: var(--accent-color);
            background: rgba(135, 169, 255, 0.05);
        }

        .herovibes-zip-tool .drop-zone.drag-over {
            border-color: var(--accent-color);
            background: rgba(135, 169, 255, 0.1);
            border-style: solid;
        }

        .herovibes-zip-tool .drop-zone-icon {
            font-size: 40px;
            margin-bottom: 12px;
            color: var(--secondary-text);
        }

        .herovibes-zip-tool .drop-zone-text {
            font-size: 12px;
            color: var(--secondary-text);
            display: block;
        }

        .herovibes-zip-tool .drop-zone-subtext {
            font-size: 11px;
            color: var(--secondary-text);
            margin-top: 8px;
            opacity: 0.7;
            display: block;
        }

        .herovibes-zip-tool #fileInput {
            display: none;
        }

        /* ========== FILE LIST ========== */
        .herovibes-zip-tool .file-list {
            margin-top: 16px;
            max-height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: var(--primary-bg);
            border-radius: 8px;
            border: 1px solid var(--outline-color);
        }

        .herovibes-zip-tool .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--secondary-bg);
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid var(--outline-color);
        }

        .herovibes-zip-tool .file-item:last-child {
            margin-bottom: 0;
        }

        .herovibes-zip-tool .file-info {
            flex: 1;
            overflow: hidden;
        }

        .herovibes-zip-tool .file-name {
            font-size: 12px;
            color: var(--primary-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .herovibes-zip-tool .file-size {
            font-size: 11px;
            color: var(--secondary-text);
            margin-top: 2px;
        }

        .herovibes-zip-tool .file-remove {
            background: none;
            border: none;
            color: var(--error-color);
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            margin-left: 8px;
        }

        .herovibes-zip-tool .file-remove:hover {
            opacity: 0.7;
        }

        /* ========== INPUT FIELDS ========== */
        .herovibes-zip-tool .form-group {
            margin-bottom: 20px;
        }

        .herovibes-zip-tool .form-label {
            display: block;
            font-size: 12px;
            color: var(--secondary-text);
            margin-bottom: 8px;
        }

        .herovibes-zip-tool .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--primary-bg);
            border: 1px solid var(--outline-color);
            border-radius: 8px;
            color: var(--primary-text);
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .herovibes-zip-tool .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .herovibes-zip-tool .form-input::placeholder {
            color: var(--secondary-text);
            opacity: 0.6;
        }

        /* ========== PASSWORD STRENGTH ========== */
        .herovibes-zip-tool .password-strength {
            margin-top: 8px;
            height: 4px;
            background: var(--outline-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .herovibes-zip-tool .password-strength-fill {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .herovibes-zip-tool .password-strength-text {
            font-size: 11px;
            margin-top: 4px;
            color: var(--secondary-text);
        }

        /* ========== TOGGLE SWITCHES ========== */
        .herovibes-zip-tool .toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--primary-bg);
            border-radius: 8px;
            border: 1px solid var(--outline-color);
            margin-bottom: 12px;
        }

        .herovibes-zip-tool .toggle-info {
            flex: 1;
        }

        .herovibes-zip-tool .toggle-title {
            font-size: 12px;
            color: var(--primary-text);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .herovibes-zip-tool .toggle-description {
            font-size: 11px;
            color: var(--secondary-text);
            line-height: 1.4;
        }

        .herovibes-zip-tool .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            margin-left: 16px;
        }

        .herovibes-zip-tool .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .herovibes-zip-tool .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--outline-color);
            transition: .3s;
            border-radius: 24px;
        }

        .herovibes-zip-tool .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        .herovibes-zip-tool input:checked + .slider {
            background-color: var(--accent-color);
        }

        .herovibes-zip-tool input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* ========== SELECT DROPDOWN ========== */
        .herovibes-zip-tool .form-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--primary-bg);
            border: 1px solid var(--outline-color);
            border-radius: 8px;
            color: var(--primary-text);
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .herovibes-zip-tool .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* ========== REVIEW SECTION ========== */
        .herovibes-zip-tool .review-card {
            background: var(--primary-bg);
            border: 1px solid var(--outline-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .herovibes-zip-tool .review-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--outline-color);
        }

        .herovibes-zip-tool .review-row:last-child {
            border-bottom: none;
        }

        .herovibes-zip-tool .review-label {
            font-size: 12px;
            color: var(--secondary-text);
        }

        .herovibes-zip-tool .review-value {
            font-size: 12px;
            color: var(--primary-text);
            font-weight: 500;
        }

        /* ========== BUTTONS (SHIMMER EFFECT) ========== */
        .herovibes-zip-tool .btn {
            position: relative;
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            background: var(--secondary-bg);
            color: var(--primary-text);
            border: 1px solid var(--outline-color);
            cursor: pointer;
            overflow: hidden;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .herovibes-zip-tool .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 75%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            transform: skewX(-25deg);
            transition: left .7s ease-in-out;
        }

        .herovibes-zip-tool .btn:hover::before {
            left: 125%;
        }

        .herovibes-zip-tool .btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(135,169,255,0.12);
        }

        .herovibes-zip-tool .btn-primary {
            background: var(--accent-color);
            color: #191919;
            font-weight: bold;
        }

        .herovibes-zip-tool .btn-primary:hover {
            background: #9BB8FF;
        }

        .herovibes-zip-tool .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .herovibes-zip-tool .btn:disabled::before {
            display: none;
        }

        .herovibes-zip-tool .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .herovibes-zip-tool .button-group .btn {
            flex: 1;
        }

        /* ========== STATUS MESSAGES ========== */
        .herovibes-zip-tool .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            margin-top: 16px;
            display: none;
        }

        .herovibes-zip-tool .status-message.show {
            display: block;
            animation: hvZipFadeIn 0.3s ease;
        }

        .herovibes-zip-tool .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .herovibes-zip-tool .status-success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .herovibes-zip-tool .status-info {
            background: rgba(135, 169, 255, 0.1);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }
        
        /* ========== VERSION NUMBER ========== */
        .herovibes-zip-tool .tool-version {
            font-size: 10px;
            color: var(--secondary-text);
            text-align: right;
            padding-top: 12px;
            padding-right: 4px;
        }

        /* ========== MOBILE OPTIMIZATION ========== */
        @media (max-width: 640px) {
            .herovibes-zip-tool .zip-container {
                padding: 16px 12px;
            }

            .herovibes-zip-tool .progress-label {
                display: block;
            }

            .herovibes-zip-tool .progress-circle {
                width: 28px;
                height: 28px;
                font-size: 11px;
            }

            .herovibes-zip-tool .drop-zone {
                padding: 30px 16px;
            }

            .herovibes-zip-tool .file-list {
                max-height: 150px;
            }

            .herovibes-zip-tool .button-group {
                flex-direction: column;
            }

            .herovibes-zip-tool .button-group .btn {
                width: 100%;
            }
        }

        /* ========== SCROLLBAR STYLING ========== */
        .herovibes-zip-tool .file-list::-webkit-scrollbar {
            width: 6px;
        }

        .herovibes-zip-tool .file-list::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }

        .herovibes-zip-tool .file-list::-webkit-scrollbar-thumb {
            background: var(--outline-color);
            border-radius: 3px;
        }

        .herovibes-zip-tool .file-list::-webkit-scrollbar-thumb:hover {
            background: var(--hover-color);
        }
    </style>
</head>
<body>
    <div class="herovibes-zip-tool">
        <div class="zip-container">
            <div class="progress-tracker">
                <div class="progress-line">
                    <div class="progress-line-fill" id="progressFill"></div>
                </div>
                <div class="progress-step active" data-step="1">
                    <div class="progress-circle">1</div>
                    <div class="progress-label">Files</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="progress-circle">2</div>
                    <div class="progress-label">Security</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="progress-circle">3</div>
                    <div class="progress-label">Options</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="progress-circle">4</div>
                    <div class="progress-label">Review</div>
                </div>
            </div>

            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-title">Select Your Files</div>
                    <div class="step-description">Choose the files you want to secure.
                        Maximum 1 GB total.</div>
                </div>

                <label for="fileInput" class="drop-zone" id="dropZone">
                    <div>
                        <div class="drop-zone-icon">üìÅ</div>
                        <div class="drop-zone-text">Drag & drop files here or click to browse</div>
                        <div class="drop-zone-subtext">Supports all file types ‚Ä¢ Max 1 GB</div>
                    </div>
                </label>
                <input type="file" id="fileInput" multiple>

                <div class="file-list" id="fileList" style="display: none;"></div>

                <div class="button-group">
                    <button class="btn btn-primary" id="step1Next" disabled>Continue to Security</button>
                </div>
            </div>

            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-title">Set Security Options</div>
                    <div class="step-description">Create a strong password to protect your files.</div>
                 </div>

                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <input type="password" class="form-input" id="passwordInput" placeholder="Enter a strong password">
                    <div class="password-strength">
                        <div class="password-strength-fill" id="passwordStrengthFill"></div>
                    </div>
                    <div class="password-strength-text" id="passwordStrengthText">Enter a password</div>
                </div>

                <div class="toggle-group">
                    <div class="toggle-info">
                        <div class="toggle-title">Show Password</div>
                        <div class="toggle-description">Toggle password visibility</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showPasswordToggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="button-group">
                    <button class="btn" id="step2Back">Back</button>
                    <button class="btn btn-primary" id="step2Next" disabled>Continue to Options</button>
                </div>
            </div>

            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-title">Advanced Options</div>
                    <div class="step-description">Customize your ZIP file settings.</div>
                 </div>

                <div class="form-group">
                    <label class="form-label">ZIP File Name</label>
                    <input type="text" class="form-input" id="zipNameInput" placeholder="secure-archive" value="secure-archive">
                </div>

                <div class="form-group">
                    <label class="form-label">Compression Level</label>
                    <select class="form-select" id="compressionLevel">
                        <option value="0">Store (No compression - Fastest)</option>
                        <option value="6" selected>Balanced (Recommended)</option>
                        <option value="9">Maximum (Smallest size - Slowest)</option>
                    </select>
                </div>

                <div class="toggle-group">
                    <div class="toggle-info">
                        <div class="toggle-title">Anonymize Filenames</div>
                        <div class="toggle-description">Rename files to SecureFile1, SecureFile2, etc.</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="replaceFilesToggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="toggle-group">
                    <div class="toggle-info">
                        <div class="toggle-title">Strip JPEG Metadata</div>
                        <div class="toggle-description">Remove GPS and camera data from images</div>
                     </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="stripMetadataToggle">
                        <span class="slider"></span>
                    </label>
                 </div>

                <div class="button-group">
                    <button class="btn" id="step3Back">Back</button>
                    <button class="btn btn-primary" id="step3Next">Review & Generate</button>
                </div>
             </div>

            <div class="step" id="step4">
                <div class="step-header">
                    <div class="step-title">Review Your Settings</div>
                    <div class="step-description">Verify
                        everything before generating your secure ZIP.</div>
                </div>

                <div class="review-card">
                    <div class="review-row">
                        <span class="review-label">Total Files</span>
                        <span class="review-value" id="reviewFileCount">0</span>
                    </div>
                    <div class="review-row">
                        <span class="review-label">Total Size</span>
                        <span class="review-value" id="reviewTotalSize">0 MB</span>
                    </div>
                    <div class="review-row">
                        <span class="review-label">ZIP Name</span>
                        <span class="review-value" id="reviewZipName">secure-archive.zip</span>
                     </div>
                    <div class="review-row">
                        <span class="review-label">Compression</span>
                        <span class="review-value" id="reviewCompression">Balanced</span>
                     </div>
                    <div class="review-row">
                        <span class="review-label">Anonymized</span>
                        <span class="review-value" id="reviewAnonymize">No</span>
                     </div>
                    <div class="review-row">
                        <span class="review-label">Metadata Stripped</span>
                        <span class="review-value" id="reviewMetadata">No</span>
                    </div>
                 </div>

                <div class="button-group">
                    <button class="btn" id="step4Back">Back</button>
                    <button class="btn btn-primary" id="generateButton">Generate Secure ZIP</button>
                </div>
             </div>

            <div class="status-message" id="statusMessage"></div>
            
            <div class="tool-version">V1.0.0</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.7.32/dist/zip-full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-stripper@1.0.1/dist/exif-stripper.min.js"></script>

    <script>
        // ========== GLOBAL VARIABLES ==========
        const MAX_FILE_SIZE = 1 * 1024 * 1024 * 1024; // 1 GB
        let currentStep = 1;
        let selectedFiles = [];
        let zipLib = null;

        // Initialize zip.js when page loads
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof zip !== 'undefined') {
                zipLib = zip;
                console.log('zip.js loaded successfully');
            } else {
                console.error('zip.js failed to load');
            }
        });
        // ========== DOM ELEMENTS ==========
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const fileList = document.getElementById('fileList');
        const passwordInput = document.getElementById('passwordInput');
        const passwordStrengthFill = document.getElementById('passwordStrengthFill');
        const passwordStrengthText = document.getElementById('passwordStrengthText');
        const showPasswordToggle = document.getElementById('showPasswordToggle');
        const zipNameInput = document.getElementById('zipNameInput');
        const compressionLevel = document.getElementById('compressionLevel');
        const replaceFilesToggle = document.getElementById('replaceFilesToggle');
        const stripMetadataToggle = document.getElementById('stripMetadataToggle');
        const statusMessage = document.getElementById('statusMessage');
        const progressFill = document.getElementById('progressFill');

        // ========== FILE UPLOAD HANDLING ==========
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            // Check for folders
            if (e.dataTransfer && e.dataTransfer.items) {
                for (let i = 0; i < e.dataTransfer.items.length; i++) {
                    const item = e.dataTransfer.items[i];
                    if (item.kind === 'file' && item.webkitGetAsEntry && item.webkitGetAsEntry().isDirectory) {
                        showStatus('Folders cannot be uploaded. Please ZIP them first.', 'error');
                        return;
                    }
                }
            }
            
            const files = e.dataTransfer.files;
            if (files.length) {
                handleFileSelection(files);
            }
        });
        fileInput.addEventListener('change', () => {
            handleFileSelection(fileInput.files);
        });
        function handleFileSelection(files) {
            if (files.length === 0) return;
            // Convert FileList to Array and add to selectedFiles
            const newFiles = Array.from(files);
            // Check total size
            let totalSize = 0;
            const allFiles = [...selectedFiles, ...newFiles];
            
            for (const file of allFiles) {
                totalSize += file.size;
            }

            if (totalSize > MAX_FILE_SIZE) {
                showStatus('Total file size exceeds 1 GB limit', 'error');
                return;
            }

            selectedFiles = allFiles;
            displayFileList();
            document.getElementById('step1Next').disabled = false;
        }

        function displayFileList() {
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
            } else {
                fileList.style.display = 'block';
            }

            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="file-remove" onclick="removeFile(${index})" type="button">√ó</button>
                `;
                fileList.appendChild(fileItem);
            });
            scheduleHeightCheck(); // Notify iframe of content change
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFileList();
            
            if (selectedFiles.length === 0) {
                document.getElementById('step1Next').disabled = true;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        // ========== PASSWORD STRENGTH CHECKER ==========
        passwordInput.addEventListener('input', () => {
            const password = passwordInput.value;
            const strength = calculatePasswordStrength(password);
            
            if (password.length === 0) {
                passwordStrengthFill.style.width = '0%';
                passwordStrengthText.textContent = 'Enter a password';
                passwordStrengthText.style.color = 'var(--secondary-text)';
                document.getElementById('step2Next').disabled = true;
                return;
            }

            passwordStrengthFill.style.width = strength.percent + '%';
            passwordStrengthFill.style.background = strength.color;
            passwordStrengthText.textContent = strength.text;
            passwordStrengthText.style.color = strength.color;
            
            // Allow any password length > 0
            document.getElementById('step2Next').disabled = false;
        });
        function calculatePasswordStrength(password) {
            let score = 0;
            // Length requirements (stricter)
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (password.length >= 16) score++;
            
            // Character variety (stricter)
            const hasLower = /[a-z]/.test(password);
            const hasUpper = /[A-Z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[^a-zA-Z\d]/.test(password);
            if (hasLower && hasUpper) score++;
            if (hasNumber) score++;
            if (hasSpecial) score++;
            
            // Bonus for having all character types
            if (hasLower && hasUpper && hasNumber && hasSpecial) score++;
            const strengths = [
                { text: 'Very Weak', color: '#EF4444', percent: 15 },
                { text: 'Weak', color: '#F59E0B', percent: 30 },
                { text: 'Fair', color: '#F59E0B', percent: 45 },
                { text: 'Fair', color: '#F59E0B', percent: 60 },
                { text: 'Good', color: '#4CAF50', percent: 75 },
                { text: 'Strong', color: '#4CAF50', percent: 90 },
                { text: 'Very Strong', color: '#4CAF50', percent: 100 }
            ];
            // Cap score at available strength levels
            const finalScore = Math.min(score, strengths.length - 1);
            return { ...strengths[finalScore], score };
        }

        // ========== SHOW PASSWORD TOGGLE ==========
        showPasswordToggle.addEventListener('change', () => {
            passwordInput.type = showPasswordToggle.checked ? 'text' : 'password';
        });
        // ========== STEP NAVIGATION ==========
        document.getElementById('step1Next').addEventListener('click', () => goToStep(2));
        document.getElementById('step2Back').addEventListener('click', () => goToStep(1));
        document.getElementById('step2Next').addEventListener('click', () => goToStep(3));
        document.getElementById('step3Back').addEventListener('click', () => goToStep(2));
        document.getElementById('step3Next').addEventListener('click', () => {
            updateReview();
            goToStep(4);
        });
        document.getElementById('step4Back').addEventListener('click', () => goToStep(3));

        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.herovibes-zip-tool .step').forEach(s => s.classList.remove('active'));
            // Show target step
            document.getElementById('step' + step).classList.add('active');
            // Update progress tracker
            updateProgressTracker(step);
            
            currentStep = step;
            hideStatus();
            scheduleHeightCheck(); // Notify iframe of content change
        }

        function updateProgressTracker(step) {
            const steps = document.querySelectorAll('.herovibes-zip-tool .progress-step');
            steps.forEach((s, index) => {
                const stepNum = index + 1;
                s.classList.remove('active', 'completed');
                
                if (stepNum < step) {
                    s.classList.add('completed');
                    s.querySelector('.progress-circle').textContent = '‚úì';
                } else if (stepNum === step) {
                    s.classList.add('active');
                    s.querySelector('.progress-circle').textContent = stepNum;
                } else {
                    s.querySelector('.progress-circle').textContent = stepNum;
                }
            });
            // Update progress fill
            const percent = ((step - 1) / 3) * 100;
            progressFill.style.width = percent + '%';
        }

        // ========== REVIEW SECTION ==========
        function updateReview() {
            const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
            document.getElementById('reviewFileCount').textContent = selectedFiles.length;
            document.getElementById('reviewTotalSize').textContent = formatFileSize(totalSize);
            
            const zipName = zipNameInput.value.trim() || 'secure-archive';
            document.getElementById('reviewZipName').textContent = zipName + '.zip';
            const compressionText = {
                '0': 'Store (No compression)',
                '6': 'Balanced',
                '9': 'Maximum'
            };
            document.getElementById('reviewCompression').textContent = compressionText[compressionLevel.value];
            
            document.getElementById('reviewAnonymize').textContent = replaceFilesToggle.checked ? 'Yes' : 'No';
            document.getElementById('reviewMetadata').textContent = stripMetadataToggle.checked ? 'Yes' : 'No';
        }

        // ========== ZIP GENERATION ==========
        document.getElementById('generateButton').addEventListener('click', async () => {
            if (!passwordInput.value) {
                showStatus('Please enter a password', 'error');
                return;
            }

            // Check if zip.js is loaded
            if (!zipLib || typeof zipLib.ZipWriter === 'undefined') {
                showStatus('Error: ZIP library not loaded. Please refresh the page.', 'error');
                console.error('zip.js not available:', zipLib);
                return;
            }

            const generateButton = document.getElementById('generateButton');
            generateButton.disabled = true;
            generateButton.textContent = 'Generating...';
            
            showStatus('Creating your secure ZIP file...', 'info');

            try {
                await createSecureZip();
                showStatus('Success! Your download has started.', 'success');
                
                // Reset form after 3 seconds
                setTimeout(() => {
                    resetForm();
                }, 3000);
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
                console.error('ZIP generation error:', error);
            } finally {
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Secure ZIP';
            }
        });
        // Detect user's operating system
        function detectOS() {
            const userAgent = window.navigator.userAgent;
            const platform = window.navigator.platform;
            const macosPlatforms = ['Macintosh', 'MacIntel', 'MacPPC', 'Mac68K'];
            const windowsPlatforms = ['Win32', 'Win64', 'Windows', 'WinCE'];
            if (macosPlatforms.indexOf(platform) !== -1) {
                return 'MacOS';
            } else if (windowsPlatforms.indexOf(platform) !== -1) {
                return 'Windows';
            } else if (/Linux/.test(platform)) {
                return 'Linux';
            }
            return 'Unknown';
        }

        async function createSecureZip() {
            const password = passwordInput.value;
            const compression = parseInt(compressionLevel.value);
            const replaceFilenames = replaceFilesToggle.checked;
            const stripMetadata = stripMetadataToggle.checked;
            const userOS = detectOS();
            console.log('Creating ZIP for OS:', userOS);
            
            // Use zip.js with proper initialization
            const zipWriter = new zipLib.ZipWriter(
                new zipLib.BlobWriter("application/zip"),
                { 
                    password, 
                    encryptionStrength: 3, // AES-256 encryption (works on all OS)
                    zipCrypto: false, // Use AES instead of ZipCrypto for better security
                    useWebWorkers: false,
                    level: compression
                }
             );
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                let fileToAdd = file;
                let fileName = file.name;

                showStatus(`Processing ${i + 1} of ${selectedFiles.length}: ${file.name}`, 'info');
                // Strip metadata from JPEG files
                if (stripMetadata && file.type === 'image/jpeg') {
                    try {
                        const fileBuffer = await file.arrayBuffer();
                        const strippedBuffer = ExifStripper.remove(fileBuffer);
                        fileToAdd = new Blob([strippedBuffer], { type: file.type });
                    } catch (e) {
                        console.error("Could not strip metadata from", file.name, e);
                    }
                }
                
                // Replace filenames if anonymization is enabled
                if (replaceFilenames) {
                    const extension = file.name.slice(file.name.lastIndexOf('.'));
                    fileName = `SecureFile${i + 1}${extension}`;
                }

                // Normalize path separators for cross-platform compatibility
                fileName = fileName.replace(/\\/g, '/');
                await zipWriter.add(fileName, new zipLib.BlobReader(fileToAdd));
            }

            showStatus('Finalizing ZIP file...', 'info');
            const zipBlob = await zipWriter.close();
            
            // Download the ZIP
            const zipName = (zipNameInput.value.trim() || 'secure-archive') + '.zip';
            const downloadUrl = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = zipName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(downloadUrl);
            console.log('ZIP created successfully for', userOS);
        }

        // ========== STATUS MESSAGES ==========
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message status-' + type + ' show';
            scheduleHeightCheck(); // Notify iframe of content change
        }

        function hideStatus() {
            statusMessage.classList.remove('show');
            scheduleHeightCheck(); // Notify iframe of content change
        }

        // ========== RESET FORM ==========
        function resetForm() {
            selectedFiles = [];
            fileInput.value = '';
            passwordInput.value = '';
            zipNameInput.value = 'secure-archive';
            compressionLevel.value = '6';
            replaceFilesToggle.checked = false;
            stripMetadataToggle.checked = false;
            showPasswordToggle.checked = false;
            passwordInput.type = 'password';
            
            displayFileList();
            goToStep(1);
            
            document.getElementById('step1Next').disabled = true;
            passwordStrengthFill.style.width = '0%';
            passwordStrengthText.textContent = 'Enter a password';
        }

        // ========== DEVELOPER CONSOLE LOG ==========
        console.log('%cüé® Secure ZIP Generator - HeroVibes', 'color: #87A9FF; font-size: 16px; font-weight: bold;');
        console.log('%cBuilt with love for creators', 'color: #8C8C8C; font-size: 12px;');

        // ===== FOURTHWALL SCROLLBAR FIX =====
        let lastHeight = 0;
        let resizeTimer;
        /**
         * Sends the current scrollHeight to the parent window if it has changed.
         * This is the *only* function that should send a postMessage.
         */
        function sendHeight() {
          // Use scrollHeight for content height
          const height = document.body.scrollHeight;
          // Only send message if height has *actually* changed
          if (height !== lastHeight) {
            lastHeight = height;
            window.parent.postMessage({ frameHeight: height }, '*');
          }
        }

        /**
         * A debounced version of sendHeight() to be called on content changes.
         * This ensures we don't spam messages during rapid changes.
         */
        function scheduleHeightCheck() {
            // Clear any pending checks
            clearTimeout(resizeTimer);
            // Schedule a new check after 150ms
            resizeTimer = setTimeout(sendHeight, 150);
        }

        // Send height on initial load (with a slight delay)
        // This fixes the "Content Cut-Off" race condition.
        window.addEventListener('load', () => {
            setTimeout(sendHeight, 100);
        });
        // Send height on window resize (debounced)
        window.addEventListener('resize', () => {
            // Use scheduleHeightCheck for built-in debounce
            scheduleHeightCheck();
        });
        // ===== END OF SCROLLBAR FIX =====
    </script>
</body>
</html>
