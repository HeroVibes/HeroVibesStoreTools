<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Card Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ===== ROOT VARIABLES (DESIGN GUIDE) ===== */
        :root {
            --bg: #191919;
            --card-bg: #1F1F1F;
            --hover: #323232;
            --outline: #323232;
            --accent: #87A9FF;
            --text-primary: #D4D4D4;
            --text-secondary: #8C8C8C;
            --radius: 8px;
            --bingo-bg: #FFFFFF;
            --bingo-border: #CCCCCC;
            --bingo-square-even: #F8F8F8;
            --bingo-square-odd: #EEEEEE;
            --bingo-square-hover: #E6E6E6;
            --bingo-text: #333333;
            --bingo-title: #333333;
        }

        /* ===== DARK MODE FOR BINGO CARD ===== */
        .dark-card {
            --bingo-bg: #2A2A2A;
            --bingo-border: #404040;
            --bingo-square-even: #333333;
            --bingo-square-odd: #3A3A3A;
            --bingo-square-hover: #454545;
            --bingo-text: #D4D4D4;
            --bingo-title: #D4D4D4;
        }

        /* ===== BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            padding: 24px 16px;
        }

        /* ===== MAIN CONTAINER ===== */
        #bingoApp {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        /* ===== CONTROLS SECTION ===== */
        .controls {
            background: var(--card-bg);
            border: 1px solid var(--outline);
            border-radius: var(--radius);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
        }

        /* ===== HELP BUTTON (REQ 2 FIX) ===== */
        #helpBtn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            background: var(--outline);
            border: 1px solid var(--outline);
            color: var(--text-secondary);
            border-radius: var(--radius) !important; /* Force override */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        #helpBtn:hover {
            background: var(--hover);
            color: var(--text-primary);
        }

        #helpBtn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* ===== INPUT STYLES ===== */
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg);
            border: 1px solid var(--outline);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        input[type="text"]::placeholder {
            color: var(--text-secondary);
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* ===== GRID SIZE CONTROLS ===== */
        .grid-size-controls {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .grid-size-controls .input-group {
            flex: 1;
        }

        /* ===== CUSTOM NUMBER INPUT ===== */
        .custom-number-input {
            display: flex;
            align-items: center;
        }

        .num-btn {
            width: 40px;
            height: 40px;
            background: var(--outline);
            border: 1px solid var(--outline);
            color: var(--text-primary);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s ease;
            padding: 0;
            line-height: 1;
        }

        .num-btn:hover {
            background: var(--hover);
        }

        .num-btn-minus {
            border-radius: var(--radius) 0 0 var(--radius);
        }

        .num-btn-plus {
            border-radius: 0 var(--radius) var(--radius) 0;
        }

        .custom-number-input input[type="number"] {
            width: 100%;
            height: 40px;
            padding: 10px 0;
            background: var(--bg);
            border: 1px solid var(--outline);
            border-left: none;
            border-right: none;
            border-radius: 0;
            color: var(--text-primary);
            font-size: 14px;
            text-align: center;
            transition: border-color 0.2s ease;
            -moz-appearance: textfield; /* Firefox */
        }

        /* Hide default arrows */
        .custom-number-input input[type=number]::-webkit-inner-spin-button,
        .custom-number-input input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .custom-number-input input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            border-left-color: var(--outline);
            border-right-color: var(--outline);
        }


        /* ===== BUTTON STYLES ===== */
        .btn {
            position: relative;
            padding: 10px 16px;
            border-radius: var(--radius);
            background: var(--btn-bg, #1F1F1F);
            color: var(--text, #D4D4D4);
            border: 1px solid rgba(255,255,255,0.06);
            cursor: pointer;
            overflow: hidden;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 75%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            transform: skewX(-25deg);
            transition: left 0.7s ease-in-out;
        }
        
        .btn:hover {
            background: var(--hover);
        }

        .btn:hover::before {
            left: 125%;
        }
        
        .btn:active {
            transform: scale(0.98);
        }

        .btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(135,169,255,0.12);
        }

        .btn-primary {
            background: var(--accent);
            color: #000000;
            border-color: var(--accent);
        }

        .btn-primary:hover {
            background: #6B8FE5;
        }

        #generateGridBtn {
            height: 40px; /* Match custom number input height */
        }

        /* ===== THEME TOGGLE ===== */
        .theme-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg);
            border-radius: var(--radius);
        }

        .theme-toggle-label {
            font-size: 12px;
            color: var(--text-secondary);
            flex: 1;
        }

        .theme-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--outline);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .theme-toggle.active {
            background: var(--accent);
        }

        .theme-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .theme-toggle.active .theme-toggle-slider {
            transform: translateX(24px);
        }

        /* ===== BUTTON ROW ===== */
        .button-row {
            display: flex;
            gap: 12px;
        }

        .button-row .btn {
            flex: 1;
        }

        /* ===== BINGO CARD CONTAINER ===== */
        #bingoCardContainer {
            background: var(--bingo-bg);
            border: 1px solid var(--bingo-border);
            border-radius: var(--radius);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        /* ===== TITLE DISPLAY ===== */
        #bingoTitleDisplay {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            color: var(--bingo-title);
            width: 100%;
            max-width: 100%;
            padding: 0 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.3s ease;
        }

        /* ===== BINGO GRID ===== */
        #bingoGrid {
            display: grid;
            width: 100%;
            max-width: 600px;
            gap: 4px;
            padding: 4px;
            background: var(--bingo-border);
            border: 2px solid var(--bingo-border);
            border-radius: var(--radius);
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        /* ===== BINGO SQUARES ===== */
        .bingo-square {
            aspect-ratio: 1 / 1;
            border: 1px solid var(--bingo-border);
            border-radius: 4px;
            position: relative;
            cursor: text;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .bingo-square-even {
            background: var(--bingo-square-even);
        }

        .bingo-square-odd {
            background: var(--bingo-square-odd);
        }

        .bingo-square:hover {
            background: var(--bingo-square-hover);
        }

        .bingo-square.drag-over {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 8px rgba(135, 169, 255, 0.5);
        }

        /* ===== SQUARE CONTENT (REQ 1 FIX) ===== */
        .bingo-square-content {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 8px;
            font-size: 24px; /* Start larger */
            color: var(--bingo-text);
            line-height: 1.2;
            outline: none;
            user-select: text;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.3s ease;
        }

        .bingo-square-content:focus {
            background: rgba(135, 169, 255, 0.1);
        }

        .bingo-square-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
            margin: auto;
        }

        /* ===== VERSION NUMBER ===== */
        #versionNumber {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: right;
            padding-top: 8px;
            border-top: 1px solid var(--outline);
            margin-top: 8px;
        }

        /* ===== HELP MODAL ===== */
        #modalBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #modalBackdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #helpModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 90%;
            max-width: 600px;
            background: var(--card-bg);
            border: 1px solid var(--outline);
            border-radius: var(--radius);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        #helpModal.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--outline);
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-close-btn:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 16px;
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-body p {
            margin-bottom: 12px;
        }

        .modal-body strong {
            color: var(--accent);
            font-weight: 500;
        }
        
        .modal-body ul {
            list-style-position: inside;
            padding-left: 8px;
            margin-bottom: 12px;
        }

        .modal-body li {
            margin-bottom: 8px;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            body {
                padding: 16px 12px;
            }

            #bingoTitleDisplay {
                font-size: 32px;
            }

            #bingoGrid {
                max-width: 100%;
            }

            .bingo-square-content {
                font-size: 20px; /* Start larger on mobile too */
                padding: 6px;
            }

            .controls {
                padding: 20px 12px;
            }
            
            #helpBtn {
                top: 12px;
                right: 12px;
            }

            .grid-size-controls {
                flex-wrap: wrap;
            }

            .grid-size-controls .input-group {
                min-width: 120px;
            }

            .button-row {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            #bingoTitleDisplay {
                font-size: 24px;
            }

            .bingo-square-content {
                font-size: 16px; /* Start larger on small mobile */
                padding: 4px;
            }

            input[type="text"],
            .btn {
                font-size: 13px;
            }
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }
    </style>
</head><body>
    <div id="bingoApp">
        <div class="controls">
            <button id="helpBtn" type="button" aria-label="Show help">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9.09 9.00002C9.3251 8.33168 9.78915 7.76811 10.4 7.41692C11.0108 7.06573 11.7289 6.95008 12.4272 7.08652C13.1255 7.22295 13.7588 7.60499 14.2151 8.16912C14.6714 8.73325 14.9211 9.44826 14.92 10.18C14.92 11.2 14.11 11.89 13.42 12.43C12.9103 12.8123 12.4542 13.251 12.07 13.73C11.9793 13.864 11.91 14.015 11.86 14.17C11.81 14.33 11.79 14.5 11.79 14.67V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 19.01L12.01 18.999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>

            <div class="input-group">
                <label class="input-label" for="bingoTitleInput">Bingo Card Title</label>
                <input type="text" id="bingoTitleInput" placeholder="Enter your bingo card title" value="Bingo Card">
            </div>

            <div class="grid-size-controls">
                <div class="input-group">
                    <label class="input-label" for="rowsInput">Rows</label>
                    <div class="custom-number-input">
                        <button type="button" class="num-btn num-btn-minus" aria-label="Decrease rows" data-input-id="rowsInput">-</button>
                        <input type="number" id="rowsInput" value="5" min="1" max="10">
                        <button type="button" class="num-btn num-btn-plus" aria-label="Increase rows" data-input-id="rowsInput">+</button>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label" for="colsInput">Columns</label>
                    <div class="custom-number-input">
                        <button type="button" class="num-btn num-btn-minus" aria-label="Decrease columns" data-input-id="colsInput">-</button>
                        <input type="number" id="colsInput" value="5" min="1" max="10">
                        <button type="button" class="num-btn num-btn-plus" aria-label="Increase columns" data-input-id="colsInput">+</button>
                    </div>
                </div>
                <button class="btn btn-primary" id="generateGridBtn">Generate</button>
            </div>

            <div class="theme-toggle-wrapper">
                <span class="theme-toggle-label">Card Theme</span>
                <div class="theme-toggle" id="themeToggle" role="switch" aria-checked="false" tabindex="0">
                    <div class="theme-toggle-slider"></div>
                </div>
                <span class="input-label" id="themeLabel">Light</span>
            </div>

            <div class="button-row">
                <button class="btn" id="clearAllBtn">Clear All</button>
                <button class="btn btn-primary" id="savePngBtn">Save as PNG</button>
            </div>

            <div id="versionNumber">V1.0.3</div>
        </div>

        <div id="bingoCardContainer">
            <h1 id="bingoTitleDisplay">Bingo Card</h1>
            <div id="bingoGrid"></div>
        </div>
    </div>

    <div id="modalBackdrop"></div>
    <div id="helpModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-header">
            <h2 id="modalTitle" class="modal-title">Bingo Card Generator Help</h2>
            <button class="modal-close-btn" id="closeModalBtn" aria-label="Close modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>Welcome! Here's how to use the Bingo Card Generator:</p>
            <ul>
                <li><strong>Card Title:</strong> Type your title in the "Bingo Card Title" box. It will update on the card live.</li>
                <li><strong>Grid Size:</strong> Use the <strong>+</strong> and <strong>-</strong> buttons to set the number of rows and columns (from 1 to 10). Click <strong>Generate</strong> to create your new grid.</li>
                <li><strong>Adding Content:</strong> Click on any square to start typing. The text will automatically shrink to fit any long words and new lines.</li>
                <li><strong>Adding Images:</strong> You can drag-and-drop an image file from your computer directly onto a square. You can also paste an image from your clipboard.</li>
                <li><strong>Card Theme:</strong> Use the "Card Theme" toggle to switch the bingo card between a light and dark design.</li>
                <li><strong>Clear All:</strong> This button will clear all text and images from every square on the current grid.</li>
                <li><strong>Save as PNG:</strong> This will capture your bingo card (including the title and all content) and save it as a high-quality PNG file to your computer.</li>
            </ul>
        </div>
    </div>

    <script>
        // ===== DOM ELEMENT REFERENCES =====
        const bingoTitleInput = document.getElementById('bingoTitleInput');
        const bingoTitleDisplay = document.getElementById('bingoTitleDisplay');
        const rowsInput = document.getElementById('rowsInput');
        const colsInput = document.getElementById('colsInput');
        const generateGridBtn = document.getElementById('generateGridBtn');
        const savePngBtn = document.getElementById('savePngBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const bingoGrid = document.getElementById('bingoGrid');
        const bingoCardContainer = document.getElementById('bingoCardContainer');
        const themeToggle = document.getElementById('themeToggle');
        const themeLabel = document.getElementById('themeLabel');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // ===== STATE MANAGEMENT =====
        let isDarkMode = false;
        
        // Create measuring spans for text-fitting
        const singleLineTestSpan = document.createElement('span');
        singleLineTestSpan.style.visibility = 'hidden';
        singleLineTestSpan.style.position = 'absolute';
        singleLineTestSpan.style.whiteSpace = 'nowrap';
        document.body.appendChild(singleLineTestSpan);


        // ===== TITLE UPDATE HANDLER =====
        bingoTitleInput.addEventListener('input', () => {
            bingoTitleDisplay.textContent = bingoTitleInput.value || 'Bingo Card';
            fitTitleText();
        });

        // ===== THEME TOGGLE HANDLER =====
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            themeToggle.classList.toggle('active', isDarkMode);
            themeToggle.setAttribute('aria-checked', isDarkMode);
            bingoCardContainer.classList.toggle('dark-card', isDarkMode);
            themeLabel.textContent = isDarkMode ? 'Dark' : 'Light';
        }
        themeToggle.addEventListener('click', toggleTheme);
        themeToggle.addEventListener('keydown', (e) => {
             if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleTheme();
            }
        });

        // ===== CLEAR ALL HANDLER =====
        clearAllBtn.addEventListener('click', () => {
            const squares = document.querySelectorAll('.bingo-square-content');
            squares.forEach(square => {
                square.innerHTML = '';
                square.style.fontSize = '';
            });
            scheduleHeightCheck();
        });
        
        // ===== CUSTOM NUMBER INPUT HANDLERS =====
        document.querySelectorAll('.num-btn-minus').forEach(btn => {
            btn.addEventListener('click', () => {
                const inputId = btn.dataset.inputId;
                const input = document.getElementById(inputId);
                if (input) {
                    input.stepDown();
                }
            });
        });

        document.querySelectorAll('.num-btn-plus').forEach(btn => {
            btn.addEventListener('click', () => {
                const inputId = btn.dataset.inputId;
                const input = document.getElementById(inputId);
                if (input) {
                    input.stepUp();
                }
            });
        });

push

        // ===== HELP MODAL HANDLERS =====
        function openModal() {
            helpModal.classList.add('visible');
            modalBackdrop.classList.add('visible');
        }

        function closeModal() {
            helpModal.classList.remove('visible');
            modalBackdrop.classList.remove('visible');
        }
        
        helpBtn.addEventListener('click', openModal);
        closeModalBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', closeModal);
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && helpModal.classList.contains('visible')) {
                closeModal();
            }
        });

        // ===== GRID GENERATION FUNCTION =====
        function generateGrid() {
            const rows = parseInt(rowsInput.value);
            const cols = parseInt(colsInput.value);

            if (isNaN(rows) || isNaN(cols) || rows < 1 || cols < 1 || rows > 10 || cols > 10) {
                alert('Please enter valid numbers between 1 and 10 for rows and columns.');
                return;
            }

            bingoGrid.innerHTML = '';
            bingoGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            bingoGrid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

            for (let i = 0; i < rows * cols; i++) {
                const square = document.createElement('div');
                square.classList.add('bingo-square');
                square.classList.add(i % 2 === 0 ? 'bingo-square-even' : 'bingo-square-odd');
                
                const squareContent = document.createElement('div');
                squareContent.classList.add('bingo-square-content');
                squareContent.setAttribute('contenteditable', 'true');
                squareContent.setAttribute('role', 'textbox');
                squareContent.setAttribute('aria-label', `Bingo square ${i + 1}`);

                square.appendChild(squareContent);

                square.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    square.classList.add('drag-over');
                });
                square.addEventListener('dragleave', () => {
                    square.classList.remove('drag-over');
                });
                square.addEventListener('drop', (e) => {
                    e.preventDefault();
                    square.classList.remove('drag-over');
                    const files = e.dataTransfer.files;
                
                    if (files.length > 0 && files[0].type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            squareContent.innerHTML = `<img src="${event.target.result}" alt="Bingo image">`;
                            squareContent.style.fontSize = '';
                        };
                        reader.readAsDataURL(files[0]);
                    } else {
                        squareContent.textContent = e.dataTransfer.getData('text/plain');
                        fitTextInSquare(squareContent);
                    }
                    scheduleHeightCheck();
                });

                squareContent.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    let handled = false;
                    
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            const blob = items[i].getAsFile();
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                squareContent.innerHTML = `<img src="${event.target.result}" alt="Bingo image">`;
                                squareContent.style.fontSize = '';
                            };
                            reader.readAsDataURL(blob);
                            handled = true;
                            break;
                        }
                    }
                    
                    if (!handled) {
                        const text = (e.clipboardData || e.originalEvent.clipboardData).getData('text/plain');
                        if (text.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
                            squareContent.innerHTML = `<img src="${text}" alt="Bingo image">`;
                            squareContent.style.fontSize = '';
                        } else {
                            const sanitizedText = text.replace(/\n/g, '<br>');
                            document.execCommand('insertHTML', false, sanitizedText);
                            fitTextInSquare(squareContent);
                        }
                    }
                    scheduleHeightCheck();
                });

                squareContent.addEventListener('input', () => {
                    squareContent.style.fontSize = '';
                    fitTextInSquare(squareContent);
                    scheduleHeightCheck();
                });

                // REQ 3 FIX: Handle 'Enter' key press
                squareContent.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Stop default (e.g., new paragraph)
                        document.execCommand('insertHTML', false, '<br>'); // Insert line break
                        
                        // Manually trigger updates
                        fitTextInSquare(squareContent);
                        scheduleHeightCheck();
                    }
                });

                squareContent.addEventListener('focus', () => {
                    if (squareContent.textContent.trim() === '') {
                        squareContent.offsetHeight;
                    }
                    fitTextInSquare(squareContent);
                });
                bingoGrid.appendChild(square);
            }
            
            fitTitleText();
            scheduleHeightCheck();
        }

        // ===== TEXT FITTING FUNCTIONS (REQ 1 FIX) =====
        function fitTextInSquare(contentElement) {
            if (contentElement.querySelector('img')) {
                contentElement.style.overflow = '';
                contentElement.style.textOverflow = '';
                contentElement.style.fontSize = '';
                return;
            }

            const computedStyle = getComputedStyle(contentElement);
            singleLineTestSpan.style.fontFamily = computedStyle.fontFamily;
            singleLineTestSpan.style.fontWeight = computedStyle.fontWeight;
            singleLineTestSpan.style.lineHeight = computedStyle.lineHeight;

            const preferredDefaultFontSize = 24; // Start larger
            const minFontSize = 8;
            
            const parentSquare = contentElement.closest('.bingo-square');
            const parentComputedStyle = getComputedStyle(parentSquare);
            const squareContentWidth = parentSquare.clientWidth - (parseFloat(parentComputedStyle.paddingLeft) + parseFloat(parentComputedStyle.paddingRight));
            const squareContentHeight = parentSquare.clientHeight - (parseFloat(parentComputedStyle.paddingTop) + parseFloat(parentComputedStyle.paddingBottom));

            const lines = contentElement.innerText.split('\n');
            const numLines = lines.length;
            let finalFontSize = preferredDefaultFontSize;

            while (finalFontSize >= minFontSize) {
                singleLineTestSpan.style.fontSize = `${finalFontSize}px`;

                // 1. Horizontal Check: Find the longest line
                let maxLineWidth = 0;
                lines.forEach(line => {
                    singleLineTestSpan.textContent = line || 'M'; // Use 'M' for empty lines
                    maxLineWidth = Math.max(maxLineWidth, singleLineTestSpan.scrollWidth);
                });
                const fitsHorizontally = maxLineWidth <= squareContentWidth;

                // 2. Vertical Check: Check total block height
                singleLineTestSpan.textContent = 'M'; // Get height of one line
                const singleLineHeight = singleLineTestSpan.offsetHeight;
                const totalBlockHeight = singleLineHeight * numLines;
                const fitsVertically = totalBlockHeight <= squareContentHeight;

                // 3. Check logic
                if (fitsHorizontally && fitsVertically) {
                    break; // This font size fits
                } else {
                    finalFontSize -= 0.5; // Doesn't fit, shrink
                }
            }
            
            finalFontSize = Math.max(finalFontSize, minFontSize);
            contentElement.style.fontSize = `${finalFontSize}px`;

            // Final overflow check
            if (contentElement.scrollHeight > contentElement.clientHeight || contentElement.scrollWidth > contentElement.clientWidth) {
                contentElement.style.overflow = 'hidden';
                contentElement.style.textOverflow = 'ellipsis';
            } else {
                contentElement.style.overflow = '';
                contentElement.style.textOverflow = '';
            }
        }

        function fitTitleText() {
            const titleElement = bingoTitleDisplay;
            const containerWidth = bingoCardContainer.clientWidth;
            const maxFontSize = 48;
            const minFontSize = 20;
            const padding = 40; // 20px on each side

            titleElement.style.whiteSpace = 'nowrap';
            titleElement.style.overflow = 'hidden';
            titleElement.style.textOverflow = 'ellipsis';
            titleElement.style.fontSize = `${maxFontSize}px`;

            let currentFontSize = maxFontSize;
            while (titleElement.scrollWidth > (containerWidth - padding) && currentFontSize > minFontSize) {
                currentFontSize -= 1;
                titleElement.style.fontSize = `${currentFontSize}px`;
            }

            if (titleElement.scrollWidth > (containerWidth - padding) && currentFontSize === minFontSize) {
                titleElement.style.whiteSpace = 'normal';
                titleElement.style.overflow = '';
                titleElement.style.textOverflow = '';
            } else {
                titleElement.style.whiteSpace = 'nowrap';
                titleElement.style.overflow = 'hidden';
                titleElement.style.textOverflow = 'ellipsis';
            }
        }

GWAN

        // ===== PNG SAVE FUNCTION =====
        savePngBtn.addEventListener('click', () => {
            const originalControlsStyle = document.querySelector('.controls').style.cssText;
            const originalTitleStyle = bingoTitleDisplay.style.cssText;
            const originalSquareContentStyles = [];

            document.querySelector('.controls').style.display = 'none';
            
            bingoTitleDisplay.style.whiteSpace = 'normal';
            bingoTitleDisplay.style.overflow = 'visible';
            bingoTitleDisplay.style.textOverflow = 'clip';

            document.querySelectorAll('.bingo-square-content').forEach(contentDiv => {
                originalSquareContentStyles.push(contentDiv.style.cssText);
                contentDiv.style.overflow = 'visible';
                contentDiv.style.textOverflow = 'clip';
            });

            scheduleHeightCheck();

            html2canvas(bingoCardContainer, {
                scale: 2,
                logging: false,
                useCORS: true,
                backgroundColor: isDarkMode ? '#2A2A2A' : '#FFFFFF'
            }).then(canvas => {
                document.querySelector('.controls').style.cssText = originalControlsStyle;
                bingoTitleDisplay.style.cssText = originalTitleStyle;
                document.querySelectorAll('.bingo-square-content').forEach((contentDiv, index) => {
                    contentDiv.style.cssText = originalSquareContentStyles[index];
                });
                
                scheduleHeightCheck();

                const link = document.createElement('a');
                const title = bingoTitleInput.value || 'bingo_card';
                link.download = `${title.replace(/\s+/g, '_').toLowerCase()}.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            }).catch(error => {
                console.error("WEB TOOL CODER: Error saving PNG:", error);
                alert("Failed to save Bingo Card. Please try again.");
                
                document.querySelector('.controls').style.cssText = originalControlsStyle;
                bingoTitleDisplay.style.cssText = originalTitleStyle;
                document.querySelectorAll('.bingo-square-content').forEach((contentDiv, index) => {
                    contentDiv.style.cssText = originalSquareContentStyles[index];
                });
                scheduleHeightCheck();
            });
        });

        // ===== EVENT LISTENERS =====
        generateGridBtn.addEventListener('click', generateGrid);

        window.addEventListener('resize', () => {
            fitTitleText();
            document.querySelectorAll('.bingo-square-content').forEach(fitTextInSquare);
        });

        // ===== INITIAL SETUP =====
        bingoTitleInput.value = 'Bingo Card';
        bingoTitleDisplay.textContent = bingoTitleInput.value;
        
        // ===== FOURTHWALL SCROLLBAR FIX =====
        let lastHeight = 0;
        let resizeTimer;

        function sendHeight() {
            const height = document.body.scrollHeight;
            if (height !== lastHeight) {
                lastHeight = height;
                window.parent.postMessage({ frameHeight: height }, '*');
            }
        }

        function scheduleHeightCheck() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(sendHeight, 150);
        }

        window.addEventListener('load', () => {
            generateGrid();
            setTimeout(sendHeight, 100);
        });

        window.addEventListener('resize', () => {
            scheduleHeightCheck();
        });
        // ===== END OF SCROLLBAR FIX =====
    </script>
</body>
</html>
