<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blurry Wallpaper Generator</title>
    <style>
        :root {
            --bg: #191919;
            --card-bg: #1F1F1F;
            --hover: #323232;
            --outline: #323232;
            --accent: #87A9FF;
            --text-primary: #D4D4D4;
            --text-secondary: #8C8C8C;
            --radius: 8px;
            --blur-strength: 120px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            padding: 24px 16px;
        }

        #app-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        #preview-section {
            flex: 1;
            min-width: 300px;
            background: var(--card-bg);
            border: 1px solid var(--outline);
            border-radius: var(--radius);
            padding: 16px;
        }

        #wallpaper-preview {
            width: 100%;
            aspect-ratio: 16 / 9;
            position: relative;
            overflow: hidden;
            background: #000;
            border-radius: var(--radius);
        }

        #texture-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        .color-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(var(--blur-strength));
            transition: all 0.3s ease;
            z-index: 1;
        }

        #controls {
            flex: 1;
            min-width: 300px;
            max-width: 450px;
            background: var(--card-bg);
            border: 1px solid var(--outline);
            border-radius: var(--radius);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .control-sublabel {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: -8px;
        }

        #color-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }

        .color-picker-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
        }

        .color-picker {
            width: 100%;
            height: 100%;
            border: 2px solid var(--outline);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
        }

        .color-picker:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .color-picker::-moz-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .slider-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slider-value {
            font-size: 12px;
            color: var(--accent);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: var(--outline);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent);
            cursor: pointer;
            border-radius: 50%;
            border: none;
            transition: all 0.2s ease;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        .texture-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .texture-option {
            padding: 8px 12px;
            background: var(--bg);
            border: 1px solid var(--outline);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .texture-option:hover {
            background: var(--hover);
        }

        .texture-option.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .btn {
            position: relative;
            flex: 1;
            padding: 12px 16px;
            border-radius: var(--radius);
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,0.06);
            cursor: pointer;
            overflow: hidden;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 75%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            transform: skewX(-25deg);
            transition: left 0.7s ease-in-out;
        }

        .btn:hover::before {
            left: 125%;
        }

        .btn:hover {
            background: var(--hover);
        }

        .btn-primary {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .btn-primary:hover {
            background: #9BB8FF;
        }

        .btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(135,169,255,0.12);
        }

        @media (max-width: 768px) {
            #app-container {
                gap: 16px;
            }

            #controls {
                max-width: 100%;
            }

            #color-grid {
                grid-template-columns: repeat(5, 1fr);
            }

            .texture-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        
        <div id="preview-section">
            <div id="wallpaper-preview">
                <div id="texture-overlay"></div>
                <div class="color-blob" id="blob1"></div>
                <div class="color-blob" id="blob2"></div>
                <div class="color-blob" id="blob3"></div>
                <div class="color-blob" id="blob4"></div>
                <div class="color-blob" id="blob5"></div>
            </div>
        </div>

        <div id="controls">
            
            <div class="control-group">
                <div class="control-label">Colors</div>
                <div class="control-sublabel">Click to change individual colors</div>
                <div id="color-grid">
                    <div class="color-picker-wrapper">
                        <input type="color" class="color-picker" id="color1">
                    </div>
                    <div class="color-picker-wrapper">
                        <input type="color" class="color-picker" id="color2">
                    </div>
                    <div class="color-picker-wrapper">
                        <input type="color" class="color-picker" id="color3">
                    </div>
                    <div class="color-picker-wrapper">
                        <input type="color" class="color-picker" id="color4">
                    </div>
                    <div class="color-picker-wrapper">
                        <input type="color" class="color-picker" id="color5">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <div class="slider-wrapper">
                    <div class="slider-header">
                        <div class="control-label">Blur Strength</div>
                        <div class="slider-value" id="blur-value">120px</div>
                    </div>
                    <input type="range" id="blur-slider" min="30" max="300" value="120">
                </div>
            </div>

            <div class="control-group">
                <div class="slider-wrapper">
                    <div class="slider-header">
                        <div class="control-label">Blob Size</div>
                        <div class="slider-value" id="size-value">100%</div>
                    </div>
                    <input type="range" id="size-slider" min="50" max="200" value="100">
                </div>
            </div>

            <div class="control-group">
                <div class="slider-wrapper">
                    <div class="slider-header">
                        <div class="control-label">Brightness</div>
                        <div class="slider-value" id="brightness-value">100%</div>
                    </div>
                    <input type="range" id="brightness-slider" min="50" max="150" value="100">
                </div>
            </div>

            <div class="control-group">
                <div class="control-label">Texture Overlay</div>
                <div class="texture-grid">
                    <div class="texture-option active" data-texture="none">None</div>
                    <div class="texture-option" data-texture="noise">Noise</div>
                    <div class="texture-option" data-texture="glass">Glass</div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn" id="random-btn">Randomize</button>
                <button class="btn btn-primary" id="download-btn">Download 4K</button>
            </div>

        </div>
    </div>

    <canvas id="render-canvas" style="display: none;"></canvas>
    <canvas id="temp-canvas" style="display: none;"></canvas>

    <script>
        const preview = document.getElementById('wallpaper-preview');
        const textureOverlay = document.getElementById('texture-overlay');
        const blobs = document.querySelectorAll('.color-blob');
        const colorPickers = document.querySelectorAll('.color-picker');
        const blurSlider = document.getElementById('blur-slider');
        const sizeSlider = document.getElementById('size-slider');
        const brightnessSlider = document.getElementById('brightness-slider');
        const blurValue = document.getElementById('blur-value');
        const sizeValue = document.getElementById('size-value');
        const brightnessValue = document.getElementById('brightness-value');
        const textureOptions = document.querySelectorAll('.texture-option');
        const randomBtn = document.getElementById('random-btn');
        const downloadBtn = document.getElementById('download-btn');
        const canvas = document.getElementById('render-canvas');
        const ctx = canvas.getContext('2d');
        const tempCanvas = document.getElementById('temp-canvas');
        const tempCtx = tempCanvas.getContext('2d');

        const state = {
            blobs: [],
            sizeMultiplier: 1,
            brightness: 100,
            texture: 'none',
            backgroundColor: '#000000',
            textureParams: {
                noise: { opacity: 0.1 },
                glass: { blur: 2, noise: 0.02 }
            }
        };

        const generateRandomColor = () => {
            const hue = Math.floor(Math.random() * 360);
            const saturation = Math.floor(Math.random() * 30) + 60;
            const lightness = Math.floor(Math.random() * 30) + 40;
            return hslToHex(hue, saturation, lightness);
        };

        const generateRandomBackgroundColor = () => {
            const roll = Math.random();
            if (roll < 0.4) return '#000000'; // 40% chance black
            if (roll < 0.8) return '#FFFFFF'; // 40% chance white
            // 20% chance random dark/light color
            const hue = Math.floor(Math.random() * 360);
            const saturation = Math.floor(Math.random() * 20) + 10;
            const lightness = Math.random() > 0.5 ? randomInt(0, 15) : randomInt(85, 100);
            return hslToHex(hue, saturation, lightness);
        };

        const hslToHex = (h, s, l) => {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        };

        const randomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

        function randomizeNoiseParams() {
            state.textureParams.noise.opacity = randomInt(8, 20) / 100; // 0.08 to 0.20
        }

        function randomizeGlassParams() {
            state.textureParams.glass.blur = randomInt(1, 4);
            state.textureParams.glass.noise = randomInt(1, 4) / 100; // 0.01 to 0.04
        }

        function randomizeTextureParams() {
            switch (state.texture) {
                case 'noise':
                    randomizeNoiseParams();
                    break;
                case 'glass':
                    randomizeGlassParams();
                    break;
            }
        }

        function updatePreview() {
            document.documentElement.style.setProperty('--blur-strength', `${blurSlider.value}px`);
            blurValue.textContent = `${blurSlider.value}px`;
            sizeValue.textContent = `${sizeSlider.value}%`;
            brightnessValue.textContent = `${brightnessSlider.value}%`;
            
            state.sizeMultiplier = sizeSlider.value / 100;
            state.brightness = brightnessSlider.value;

            preview.style.backgroundColor = state.backgroundColor;
            preview.style.filter = `brightness(${state.brightness}%)`;

            state.blobs.forEach((blobState, i) => {
                const blobElement = document.getElementById(blobState.id);
                const adjustedSize = blobState.baseSize * state.sizeMultiplier;
                
                blobElement.style.backgroundColor = blobState.color;
                blobElement.style.left = `${blobState.x}%`;
                blobElement.style.top = `${blobState.y}%`;
                blobElement.style.width = `${adjustedSize}px`;
                blobElement.style.height = `${adjustedSize}px`;

                colorPickers[i].value = blobState.color;
            });
            applyTexture();
        }

        function applyTexture() {
            textureOverlay.style.backgroundImage = 'none';
            textureOverlay.style.backdropFilter = 'none';

            if (state.texture === 'noise') {
                textureOverlay.style.backgroundImage = `
                    repeating-linear-gradient(
                        0deg,
                        transparent,
                        transparent 2px,
                        rgba(0,0,0,${state.textureParams.noise.opacity}) 2px,
                        rgba(0,0,0,${state.textureParams.noise.opacity}) 4px
                    )
                `;
            } else if (state.texture === 'glass') {
                textureOverlay.style.backdropFilter = `blur(${state.textureParams.glass.blur}px)`;
                textureOverlay.style.backgroundImage = `
                    repeating-linear-gradient(
                        0deg,
                        transparent,
                        transparent 2px,
                        rgba(0,0,0,${state.textureParams.glass.noise}) 2px,
                        rgba(0,0,0,${state.textureParams.glass.noise}) 4px
                    )
                `;
            }
        }

        function randomizeState() {
            state.blobs = [];
            blobs.forEach((blob, i) => {
                state.blobs.push({
                    id: `blob${i + 1}`,
                    color: generateRandomColor(),
                    x: randomInt(-20, 80),
                    y: randomInt(-20, 80),
                    baseSize: randomInt(200, 500)
                });
            });

            // Randomize texture
            const textureTypes = ['none', 'noise', 'glass'];
            state.texture = textureTypes[randomInt(0, textureTypes.length - 1)];
            textureOptions.forEach(o => {
                o.classList.toggle('active', o.dataset.texture === state.texture);
            });
            randomizeTextureParams();

            // Randomize background color
            state.backgroundColor = generateRandomBackgroundColor();

            updatePreview();
            scheduleHeightCheck();
        }

        async function downloadImage() {
            const DOWNLOAD_WIDTH = 3840;
            const DOWNLOAD_HEIGHT = 2160;
            
            canvas.width = DOWNLOAD_WIDTH;
            canvas.height = DOWNLOAD_HEIGHT;
            tempCanvas.width = DOWNLOAD_WIDTH;
            tempCanvas.height = DOWNLOAD_HEIGHT;

            ctx.fillStyle = state.backgroundColor;
            ctx.fillRect(0, 0, DOWNLOAD_WIDTH, DOWNLOAD_HEIGHT);

            const previewRect = preview.getBoundingClientRect();
            const scaleX = DOWNLOAD_WIDTH / previewRect.width;
            const scaleY = DOWNLOAD_HEIGHT / previewRect.height;
            const scaleFactor = (scaleX + scaleY) / 2;

            const scaledBlur = parseInt(blurSlider.value, 10) * scaleFactor;
            ctx.filter = `blur(${scaledBlur}px) brightness(${state.brightness}%)`;
            
            state.blobs.forEach(blobState => {
                ctx.fillStyle = blobState.color;
                ctx.beginPath();
                
                const adjustedSize = blobState.baseSize * state.sizeMultiplier;
                const canvasX = (blobState.x / 100) * DOWNLOAD_WIDTH + (adjustedSize * scaleFactor / 2);
                const canvasY = (blobState.y / 100) * DOWNLOAD_HEIGHT + (adjustedSize * scaleFactor / 2);
                const canvasRadius = (adjustedSize / 2) * scaleFactor;
                
                ctx.arc(canvasX, canvasY, canvasRadius, 0, 2 * Math.PI);
                ctx.fill();
            });

            ctx.filter = 'none';

            // Apply texture
            if (state.texture === 'noise') {
                ctx.fillStyle = `rgba(0, 0, 0, ${state.textureParams.noise.opacity})`;
                for (let i = 0; i < DOWNLOAD_WIDTH * DOWNLOAD_HEIGHT / 25; i++) { // Increased strength
                    ctx.fillRect(
                        Math.random() * DOWNLOAD_WIDTH,
                        Math.random() * DOWNLOAD_HEIGHT,
                        1, 1
                    );
                }
            } else if (state.texture === 'glass') {
                // Apply blur
                tempCtx.filter = `blur(${state.textureParams.glass.blur * scaleFactor}px)`;
                tempCtx.drawImage(canvas, 0, 0);
                
                // Draw blurred version back to main canvas
                ctx.filter = 'none';
                ctx.drawImage(tempCanvas, 0, 0);

                // Apply subtle noise
                ctx.fillStyle = `rgba(0, 0, 0, ${state.textureParams.glass.noise})`;
                for (let i = 0; i < DOWNLOAD_WIDTH * DOWNLOAD_HEIGHT / 50; i++) {
                    ctx.fillRect(
                        Math.random() * DOWNLOAD_WIDTH,
                        Math.random() * DOWNLOAD_HEIGHT,
                        1, 1
                    );
                }
            }

            const link = document.createElement('a');
            link.download = 'blurry-wallpaper-4k.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            link.remove();
        }

        randomBtn.addEventListener('click', randomizeState);
        downloadBtn.addEventListener('click', downloadImage);
        
        blurSlider.addEventListener('input', () => {
            updatePreview();
            scheduleHeightCheck();
        });
        sizeSlider.addEventListener('input', () => {
            updatePreview();
            scheduleHeightCheck();
        });
        brightnessSlider.addEventListener('input', () => {
            updatePreview();
            scheduleHeightCheck();
        });

        colorPickers.forEach((picker, i) => {
            picker.addEventListener('input', (e) => {
                if (state.blobs[i]) {
                    state.blobs[i].color = e.target.value;
                    updatePreview();
                }
            });
        });

        textureOptions.forEach(option => {
            option.addEventListener('click', () => {
                const newTexture = option.dataset.texture;
                
                if (state.texture === newTexture && newTexture !== 'none') {
                    // Clicked active button: re-randomize params
                    randomizeTextureParams();
                } else {
                    // Clicked new button: switch texture
                    textureOptions.forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    state.texture = newTexture;
                    randomizeTextureParams();
                }
                
                updatePreview();
                scheduleHeightCheck();
            });
        });

        // ===== FOURTHWALL SCROLLBAR FIX =====
        let lastHeight = 0;
        let resizeTimer;

        function sendHeight() {
            const height = document.body.scrollHeight;
            if (height !== lastHeight) {
                lastHeight = height;
                window.parent.postMessage({ frameHeight: height }, '*');
            }
        }

        function scheduleHeightCheck() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(sendHeight, 150);
        }

        window.addEventListener('load', () => {
            randomizeState();
        });

        window.addEventListener('resize', () => {
            scheduleHeightCheck();
        });
        // ===== END OF SCROLLBAR FIX =====
    </script>
</body>
</html>
