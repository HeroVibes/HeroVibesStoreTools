<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ShapeStack Game</title>
  <style>
    :root {
      --bg: #191919;
      --card-bg: #1F1F1F;
      --hover: #323232;
      --outline: #323232;
      --accent: #87A9FF;
      --text-primary: #D4D4D4;
      --text-secondary: #8C8C8C;
      --radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      font-family: sans-serif;
      color: var(--text-primary);
      padding: 24px 16px;
      overflow-x: hidden;
      touch-action: manipulation;
    }

    /* ===== MAIN CONTAINER ===== */
    .game-container {
      max-width: 600px;
      margin: 0 auto;
    }

    /* ===== GAME BOARD SECTION ===== */
    .game-board-section {
      background: var(--card-bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 24px 16px;
      margin-bottom: 20px;
      position: relative;
    }

    /* ===== GAME STATUS INDICATOR ===== */
    .game-status {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-secondary);
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 6px 12px;
      background: rgba(25, 25, 25, 0.8);
      border-radius: 20px;
      border: 1px solid var(--outline);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
      transition: all 0.3s ease;
    }

    .game-status.playing .status-dot {
      background: #66ff66;
      box-shadow: 0 0 8px rgba(102, 255, 102, 0.6);
      animation: pulse 2s ease-in-out infinite;
    }

    .game-status.paused .status-dot {
      background: #ffeb3b;
      box-shadow: 0 0 8px rgba(255, 235, 59, 0.6);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ===== MOBILE PLAY/PAUSE BUTTON ===== */
    .mobile-play-pause {
      position: absolute;
      top: 12px;
      left: 12px;
      width: 44px;
      height: 44px;
      background: rgba(25, 25, 25, 0.9);
      border: 1px solid var(--outline);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);
      z-index: 10;
      transition: all 0.2s ease;
    }

    .mobile-play-pause:active {
      transform: scale(0.95);
      background: rgba(50, 50, 50, 0.9);
    }

    .mobile-play-pause svg {
      width: 20px;
      height: 20px;
      fill: var(--text-primary);
    }

    /* ===== GAME BOARD ===== */
    .board-wrapper {
      position: relative;
      background: var(--bg);
      border: 2px solid var(--outline);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      margin: 0 auto;
      max-width: 400px;
      touch-action: none;
    }

    #game-board {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 2px;
      background: rgba(50, 50, 50, 0.3);
      border-radius: 4px;
      padding: 4px;
      width: 100%;
      aspect-ratio: 10 / 20;
      touch-action: none;
    }

    .cell {
      aspect-ratio: 1;
      background: var(--card-bg);
      border-radius: 3px;
      transition: all 0.15s ease;
      position: relative;
    }

    .cell.filled {
      box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* ===== SHIMMER ANIMATION ===== */
    @keyframes shimmer {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .cell.filled.shimmer {
      animation: shimmer 1.5s ease-in-out;
    }

    /* ===== GLOW EFFECT ===== */
    @keyframes glow {
      0%, 100% { 
        filter: brightness(1);
        box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.3);
      }
      50% { 
        filter: brightness(1.3);
        box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.2);
      }
    }

    .cell.filled.glow {
      animation: glow 2s ease-in-out;
    }

    /* ===== INDIVIDUAL SHAPE COLORS ===== */
    .cell[data-color="cyan"] { background: linear-gradient(135deg, #00f5ff 0%, #00c9ff 100%); }
    .cell[data-color="blue"] { background: linear-gradient(135deg, #4d79ff 0%, #1e4dff 100%); }
    .cell[data-color="orange"] { background: linear-gradient(135deg, #ffb347 0%, #ff8c1a 100%); }
    .cell[data-color="yellow"] { background: linear-gradient(135deg, #ffeb3b 0%, #ffd600 100%); }
    .cell[data-color="green"] { background: linear-gradient(135deg, #66ff66 0%, #00ff00 100%); }
    .cell[data-color="purple"] { background: linear-gradient(135deg, #d966ff 0%, #b833ff 100%); }
    .cell[data-color="red"] { background: linear-gradient(135deg, #ff6666 0%, #ff3333 100%); }
    .cell[data-color="pink"] { background: linear-gradient(135deg, #ff66b3 0%, #ff3385 100%); }
    .cell[data-color="lime"] { background: linear-gradient(135deg, #b3ff66 0%, #85ff33 100%); }
    .cell[data-color="teal"] { background: linear-gradient(135deg, #66ffcc 0%, #33ff99 100%); }
    .cell[data-color="violet"] { background: linear-gradient(135deg, #b366ff 0%, #8533ff 100%); }
    .cell[data-color="coral"] { background: linear-gradient(135deg, #ff9966 0%, #ff6633 100%); }
    .cell[data-color="sky"] { background: linear-gradient(135deg, #66ccff 0%, #3399ff 100%); }
    .cell[data-color="gold"] { background: linear-gradient(135deg, #ffd966 0%, #ffcc33 100%); }

    /* ===== NEXT PIECE OVERLAY ===== */
    .next-piece-overlay {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: rgba(25, 25, 25, 0.9);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 12px;
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);
    }

    .next-piece-label {
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    #next-piece {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 2px;
      width: 60px;
    }

    #next-piece .cell {
      width: 13px;
      height: 13px;
    }

    /* ===== STATS SECTION ===== */
    .stats-section {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--card-bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--accent);
    }

    /* ===== CONTROLS ===== */
    .controls-section {
      background: var(--card-bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 20px 16px;
      margin-bottom: 20px;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 12px 16px;
    }

    .toggle-label {
      font-size: 14px;
      color: var(--text-primary);
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 24px;
      background: var(--hover);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle-switch.active {
      background: var(--accent);
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: var(--text-primary);
      border-radius: 50%;
      transition: transform 0.3s ease;
    }

    .toggle-switch.active .toggle-slider {
      transform: translateX(24px);
    }

    /* ===== KEYBOARD SHORTCUTS OVERLAY ===== */
    .keyboard-shortcuts {
      background: var(--card-bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
    }

    .keyboard-shortcuts h3 {
      font-size: 14px;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .shortcuts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .shortcut-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .key-badge {
      background: var(--bg);
      border: 1px solid var(--outline);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: bold;
      color: var(--text-primary);
      min-width: 32px;
      text-align: center;
    }

    .key-description {
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* ===== GAME OVER OVERLAY ===== */
    .game-over-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: flex-start;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      padding-top: 80px;
    }

    .game-over-overlay.show {
      display: flex;
    }

    .game-over-content {
      background: var(--card-bg);
      border: 2px solid var(--accent);
      border-radius: var(--radius);
      padding: 32px 24px;
      text-align: center;
      max-width: 400px;
      width: 100%;
      animation: slideIn 0.3s ease;
      position: relative;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      background: var(--bg);
      border: 1px solid var(--outline);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      font-size: 18px;
      line-height: 1;
    }

    .close-btn:hover {
      background: var(--hover);
      color: var(--text-primary);
    }

    .game-over-title {
      font-size: 28px;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 16px;
    }

    .game-over-score {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .btn {
      position: relative;
      padding: 14px 16px;
      border-radius: var(--radius);
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.06);
      cursor: pointer;
      overflow: hidden;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.2s ease;
      width: 100%;
    }

    .btn:hover {
      background: var(--hover);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 75%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
      transform: skewX(-25deg);
      transition: left 0.7s ease-in-out;
    }

    .btn:hover::before {
      left: 125%;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg);
    }

    .btn-primary:hover {
      background: #9bb8ff;
    }

    /* ===== VERSION AND INFO ===== */
    .footer-info {
      text-align: center;
      margin-top: 20px;
    }

    .version {
      font-size: 10px;
      color: var(--text-secondary);
      opacity: 0.5;
    }

    /* ===== INSTRUCTIONS ===== */
    .instructions {
      background: var(--card-bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
    }

    .instructions h3 {
      font-size: 14px;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .instructions p {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .instructions p:last-child {
      margin-bottom: 0;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      .keyboard-shortcuts {
        display: none;
      }

      .mobile-play-pause {
        display: flex;
      }

      .instructions {
        display: none;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 16px 8px;
      }

      .game-board-section {
        padding: 16px 12px;
      }

      .board-wrapper {
        padding: 8px;
      }

      .next-piece-overlay {
        bottom: 12px;
        right: 12px;
        padding: 10px;
      }

      .game-status {
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        font-size: 10px;
      }

      .stat-value {
        font-size: 20px;
      }

      .game-over-overlay {
        padding-top: 60px;
      }
    }
  </style>
</head>
<body>
  <!-- ===== GAME CONTAINER ===== -->
  <div class="game-container">

    <!-- ===== GAME BOARD SECTION ===== -->
    <div class="game-board-section">
      <!-- ===== GAME STATUS INDICATOR ===== -->
      <div class="game-status" id="game-status">
        <div class="status-dot"></div>
        <span id="status-text">Ready</span>
      </div>

      <!-- ===== MOBILE PLAY/PAUSE BUTTON ===== -->
      <div class="mobile-play-pause" id="mobile-play-pause">
        <svg id="play-icon" viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"/>
        </svg>
        <svg id="pause-icon" viewBox="0 0 24 24" style="display:none;">
          <path d="M6 4h4v16H6zm8 0h4v16h-4z"/>
        </svg>
      </div>

      <!-- ===== GAME BOARD ===== -->
      <div class="board-wrapper" id="board-wrapper">
        <div id="game-board"></div>
        
        <!-- ===== NEXT PIECE OVERLAY ===== -->
        <div class="next-piece-overlay">
          <div class="next-piece-label">Next</div>
          <div id="next-piece"></div>
        </div>
      </div>
    </div>

    <!-- ===== STATS SECTION ===== -->
    <div class="stats-section">
      <div class="stat-card">
        <div class="stat-label">Score</div>
        <div class="stat-value" id="score">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">High Score</div>
        <div class="stat-value" id="highscore">0</div>
      </div>
    </div>

    <!-- ===== KEYBOARD SHORTCUTS (Desktop Only) ===== -->
    <div class="keyboard-shortcuts">
      <h3>Keyboard Shortcuts</h3>
      <div class="shortcuts-grid">
        <div class="shortcut-item">
          <span class="key-badge">W/F/↑</span>
          <span class="key-description">Rotate</span>
        </div>
        <div class="shortcut-item">
          <span class="key-badge">A/←</span>
          <span class="key-description">Move Left</span>
        </div>
        <div class="shortcut-item">
          <span class="key-badge">D/→</span>
          <span class="key-description">Move Right</span>
        </div>
        <div class="shortcut-item">
          <span class="key-badge">S/↓</span>
          <span class="key-description">Speed Up</span>
        </div>
        <div class="shortcut-item">
          <span class="key-badge">Space</span>
          <span class="key-description">Instant Drop</span>
        </div>
        <div class="shortcut-item">
          <span class="key-badge">P/Enter</span>
          <span class="key-description">Play/Pause</span>
        </div>
        <div class="shortcut-item">
          <span class="key-badge">R</span>
          <span class="key-description">Restart</span>
        </div>
        <div class="shortcut-item">
          <span class="key-badge">T</span>
          <span class="key-description">Toggle Speed</span>
        </div>
      </div>
    </div>

    <!-- ===== CONTROLS SECTION ===== -->
    <div class="controls-section">
      <div class="toggle-container">
        <span class="toggle-label">Progressive Speed</span>
        <div class="toggle-switch active" id="speed-toggle">
          <div class="toggle-slider"></div>
        </div>
      </div>
    </div>

    <!-- ===== INSTRUCTIONS (Desktop Only) ===== -->
    <div class="instructions">
      <h3>How to Play</h3>
      <p><strong>Mobile:</strong> Tap shapes to rotate, drag to move, hold to speed up. Use play button to start/pause.</p>
      <p><strong>Desktop:</strong> Use keyboard shortcuts above to control the game.</p>
      <p><strong>Scoring:</strong> 1 line = 100pts, 2 lines = 300pts, 3 lines = 500pts, 4 lines = 800pts</p>
      <p><strong>Progressive Speed:</strong> Blocks fall 2% faster every 5 shapes when enabled</p>
    </div>

    <!-- ===== VERSION NUMBER ===== -->
    <div class="footer-info">
      <div class="version">ShapeStack v1.0</div>
    </div>
  </div>

  <!-- ===== GAME OVER OVERLAY ===== -->
  <div class="game-over-overlay" id="game-over-overlay">
    <div class="game-over-content">
      <div class="close-btn" id="close-btn">×</div>
      <div class="game-over-title">Game Over!</div>
      <div class="game-over-score" id="final-score"></div>
      <button class="btn btn-primary" id="play-again-btn">Play Again</button>
    </div>
  </div>

  <script>
    // ===== GAME CONSTANTS =====
    const ROWS = 20;
    const COLS = 10;
    const BASE_SPEED = 800;
    const FAST_DROP_SPEED = 50;
    const SPEED_INCREMENT = 0.02;
    const SPEED_INTERVAL = 5;
    const SHIMMER_INTERVAL = 2500;

    // ===== SHAPE DEFINITIONS =====
    const SHAPES = {
      I: { shape: [[1, 1, 1, 1]], color: 'cyan' },
      J: { shape: [[1, 0, 0], [1, 1, 1]], color: 'blue' },
      L: { shape: [[0, 0, 1], [1, 1, 1]], color: 'orange' },
      O: { shape: [[1, 1], [1, 1]], color: 'yellow' },
      S: { shape: [[0, 1, 1], [1, 1, 0]], color: 'green' },
      T: { shape: [[0, 1, 0], [1, 1, 1]], color: 'purple' },
      Z: { shape: [[1, 1, 0], [0, 1, 1]], color: 'red' },
      I2: { shape: [[1, 1, 1, 1]], color: 'pink' },
      J2: { shape: [[1, 0, 0], [1, 1, 1]], color: 'lime' },
      L2: { shape: [[0, 0, 1], [1, 1, 1]], color: 'teal' },
      S2: { shape: [[0, 1, 1], [1, 1, 0]], color: 'violet' },
      T2: { shape: [[0, 1, 0], [1, 1, 1]], color: 'coral' },
      Z2: { shape: [[1, 1, 0], [0, 1, 1]], color: 'sky' },
      O2: { shape: [[1, 1], [1, 1]], color: 'gold' }
    };

    // ===== GAME STATE =====
    let board = [];
    let currentPiece = null;
    let nextPiece = null;
    let score = 0;
    let highScore = localStorage.getItem('shapestack_highscore') || 0;
    let gameLoop = null;
    let shimmerLoop = null;
    let isPlaying = false;
    let isPaused = false;
    let progressiveSpeed = true;
    let currentSpeed = BASE_SPEED;
    let piecesPlaced = 0;
    let isFastDropping = false;

    // Touch controls
    let touchStartX = 0;
    let touchStartY = 0;
    let isDragging = false;
    let isHolding = false;
    let holdTimeout = null;

    // ===== DOM ELEMENTS =====
    const gameBoard = document.getElementById('game-board');
    const boardWrapper = document.getElementById('board-wrapper');
    const nextPieceBoard = document.getElementById('next-piece');
    const scoreEl = document.getElementById('score');
    const highScoreEl = document.getElementById('highscore');
    const speedToggle = document.getElementById('speed-toggle');
    const gameOverOverlay = document.getElementById('game-over-overlay');
    const finalScoreEl = document.getElementById('final-score');
    const playAgainBtn = document.getElementById('play-again-btn');
    const closeBtn = document.getElementById('close-btn');
    const gameStatus = document.getElementById('game-status');
    const statusText = document.getElementById('status-text');
    const mobilePlayPause = document.getElementById('mobile-play-pause');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');

    // ===== INITIALIZE BOARD =====
    function initBoard() {
      board = Array(ROWS).fill().map(() => Array(COLS).fill(0));
      gameBoard.innerHTML = '';
      
      for (let i = 0; i < ROWS * COLS; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        gameBoard.appendChild(cell);
      }
    }

    // ===== INITIALIZE NEXT PIECE PREVIEW =====
    function initNextPieceBoard() {
      nextPieceBoard.innerHTML = '';
      for (let i = 0; i < 16; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        nextPieceBoard.appendChild(cell);
      }
    }

    // ===== GET RANDOM SHAPE =====
    function getRandomShape() {
      const pieces = Object.keys(SHAPES);
      const randomPiece = pieces[Math.floor(Math.random() * pieces.length)];
      const shape = SHAPES[randomPiece];
      
      return {
        shape: shape.shape,
        color: shape.color,
        x: Math.floor(COLS / 2) - Math.floor(shape.shape[0].length / 2),
        y: 0
      };
    }

    // ===== SHIMMER & GLOW EFFECTS =====
    function triggerShimmer() {
      const cells = gameBoard.querySelectorAll('.cell.filled');
      cells.forEach(cell => {
        if (Math.random() > 0.5) {
          cell.classList.add('shimmer');
          setTimeout(() => cell.classList.remove('shimmer'), 1500);
        }
      });
    }

    function triggerGlow() {
      const cells = gameBoard.querySelectorAll('.cell.filled');
      cells.forEach(cell => {
        if (Math.random() > 0.6) {
          cell.classList.add('glow');
          setTimeout(() => cell.classList.remove('glow'), 2000);
        }
      });
    }

    function startShimmerLoop() {
      if (shimmerLoop) clearInterval(shimmerLoop);
      shimmerLoop = setInterval(() => {
        if (!isPaused && isPlaying) {
          Math.random() > 0.5 ? triggerShimmer() : triggerGlow();
        }
      }, SHIMMER_INTERVAL);
    }

    // ===== DRAW FUNCTIONS =====
    function drawBoard() {
      const cells = gameBoard.querySelectorAll('.cell');
      
      for (let row = 0; row < ROWS; row++) {
        for (let col = 0; col < COLS; col++) {
          const index = row * COLS + col;
          const cell = cells[index];
          
          if (board[row][col]) {
            cell.classList.add('filled');
            cell.setAttribute('data-color', board[row][col]);
          } else {
            cell.classList.remove('filled');
            cell.removeAttribute('data-color');
          }
        }
      }
    }

    function drawCurrentPiece() {
      if (!currentPiece) return;
      
      const cells = gameBoard.querySelectorAll('.cell');
      
      for (let row = 0; row < currentPiece.shape.length; row++) {
        for (let col = 0; col < currentPiece.shape[row].length; col++) {
          if (currentPiece.shape[row][col]) {
            const boardRow = currentPiece.y + row;
            const boardCol = currentPiece.x + col;
            
            if (boardRow >= 0 && boardRow < ROWS && boardCol >= 0 && boardCol < COLS) {
              const index = boardRow * COLS + boardCol;
              const cell = cells[index];
              cell.classList.add('filled');
              cell.setAttribute('data-color', currentPiece.color);
            }
          }
        }
      }
    }

    function drawNextPiece() {
      if (!nextPiece) return;
      
      const cells = nextPieceBoard.querySelectorAll('.cell');
      cells.forEach(cell => {
        cell.classList.remove('filled');
        cell.removeAttribute('data-color');
      });
      
      const offsetRow = Math.floor((4 - nextPiece.shape.length) / 2);
      const offsetCol = Math.floor((4 - nextPiece.shape[0].length) / 2);
      
      for (let row = 0; row < nextPiece.shape.length; row++) {
        for (let col = 0; col < nextPiece.shape[row].length; col++) {
          if (nextPiece.shape[row][col]) {
            const index = (offsetRow + row) * 4 + (offsetCol + col);
            const cell = cells[index];
            cell.classList.add('filled');
            cell.setAttribute('data-color', nextPiece.color);
          }
        }
      }
    }

    // ===== UPDATE GAME STATUS =====
    function updateGameStatus() {
      if (!isPlaying) {
        gameStatus.className = 'game-status';
        statusText.textContent = 'Ready';
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
      } else if (isPaused) {
        gameStatus.className = 'game-status paused';
        statusText.textContent = 'Paused';
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
      } else {
        gameStatus.className = 'game-status playing';
        statusText.textContent = 'Playing';
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
      }
    }

    // ===== CHECK COLLISION =====
    function checkCollision(piece, x, y) {
      for (let row = 0; row < piece.shape.length; row++) {
        for (let col = 0; col < piece.shape[row].length; col++) {
          if (piece.shape[row][col]) {
            const newX = x + col;
            const newY = y + row;
            
            if (newX < 0 || newX >= COLS || newY >= ROWS) {
              return true;
            }
            
            if (newY >= 0 && board[newY][newX]) {
              return true;
            }
          }
        }
      }
      return false;
    }

    // ===== MERGE PIECE =====
    function mergePiece() {
      for (let row = 0; row < currentPiece.shape.length; row++) {
        for (let col = 0; col < currentPiece.shape[row].length; col++) {
          if (currentPiece.shape[row][col]) {
            const boardRow = currentPiece.y + row;
            const boardCol = currentPiece.x + col;
            
            if (boardRow >= 0) {
              board[boardRow][boardCol] = currentPiece.color;
            }
          }
        }
      }
      
      piecesPlaced++;
      updateSpeed();
    }

    // ===== UPDATE SPEED =====
    function updateSpeed() {
      if (!progressiveSpeed) return;
      
      if (piecesPlaced % SPEED_INTERVAL === 0 && piecesPlaced > 0) {
        currentSpeed = Math.max(100, currentSpeed * (1 - SPEED_INCREMENT));
        restartGameLoop();
      }
    }

    function restartGameLoop() {
      if (gameLoop) {
        clearInterval(gameLoop);
        const activeSpeed = isFastDropping ? FAST_DROP_SPEED : currentSpeed;
        gameLoop = setInterval(gameStep, activeSpeed);
      }
    }

    // ===== CLEAR LINES =====
    function clearLines() {
      let linesCleared = 0;
      
      for (let row = ROWS - 1; row >= 0; row--) {
        if (board[row].every(cell => cell !== 0)) {
          board.splice(row, 1);
          board.unshift(Array(COLS).fill(0));
          linesCleared++;
          row++;
        }
      }
      
      if (linesCleared > 0) {
        const points = [0, 100, 300, 500, 800];
        score += points[linesCleared] || 800;
        
        if (score > highScore) {
          highScore = score;
          localStorage.setItem('shapestack_highscore', highScore);
        }
        
        updateStats();
      }
    }

    // ===== ROTATE PIECE =====
    function rotatePiece() {
      const rotated = currentPiece.shape[0].map((_, i) =>
        currentPiece.shape.map(row => row[i]).reverse()
      );
      
      const newPiece = { ...currentPiece, shape: rotated };
      
      if (!checkCollision(newPiece, newPiece.x, newPiece.y)) {
        currentPiece = newPiece;
        render();
      }
    }

    // ===== MOVE PIECE =====
    function movePiece(dx, dy) {
      const newX = currentPiece.x + dx;
      const newY = currentPiece.y + dy;
      
      if (!checkCollision(currentPiece, newX, newY)) {
        currentPiece.x = newX;
        currentPiece.y = newY;
        render();
        return true;
      }
      return false;
    }

    // ===== DROP PIECE =====
    function dropPiece() {
      while (movePiece(0, 1)) {}
    }

    // ===== GAME STEP =====
    function gameStep() {
      if (isPaused) return;
      
      if (!movePiece(0, 1)) {
        mergePiece();
        clearLines();
        currentPiece = nextPiece;
        nextPiece = getRandomShape();
        drawNextPiece();
        
        if (checkCollision(currentPiece, currentPiece.x, currentPiece.y)) {
          gameOver();
        }
      }
      
      render();
    }

    // ===== RENDER =====
    function render() {
      drawBoard();
      drawCurrentPiece();
    }

    // ===== UPDATE STATS =====
    function updateStats() {
      scoreEl.textContent = score;
      highScoreEl.textContent = highScore;
    }

    // ===== START GAME =====
    function startGame() {
      initBoard();
      score = 0;
      currentSpeed = BASE_SPEED;
      piecesPlaced = 0;
      isFastDropping = false;
      updateStats();
      
      currentPiece = getRandomShape();
      nextPiece = getRandomShape();
      drawNextPiece();
      
      isPlaying = true;
      isPaused = false;
      updateGameStatus();
      
      if (gameLoop) clearInterval(gameLoop);
      gameLoop = setInterval(gameStep, currentSpeed);
      startShimmerLoop();
      
      render();
      scheduleHeightCheck();
    }

    // ===== PAUSE GAME =====
    function pauseGame() {
      if (!isPlaying) {
        startGame();
        return;
      }
      
      isPaused = !isPaused;
      updateGameStatus();
    }

    // ===== TOGGLE PROGRESSIVE SPEED =====
    function toggleProgressiveSpeed() {
      progressiveSpeed = !progressiveSpeed;
      speedToggle.classList.toggle('active');
      
      if (!progressiveSpeed) {
        currentSpeed = BASE_SPEED;
        restartGameLoop();
      }
    }

    // ===== GAME OVER =====
    function gameOver() {
      isPlaying = false;
      clearInterval(gameLoop);
      if (shimmerLoop) clearInterval(shimmerLoop);
      updateStats();
      updateGameStatus();
      
      finalScoreEl.textContent = `Score: ${score} | High Score: ${highScore}`;
      gameOverOverlay.classList.add('show');
      scheduleHeightCheck();
    }

    // ===== FAST DROP =====
    function enableFastDrop() {
      if (!isPlaying || isPaused || isFastDropping) return;
      isFastDropping = true;
      clearInterval(gameLoop);
      gameLoop = setInterval(gameStep, FAST_DROP_SPEED);
    }

    function disableFastDrop() {
      if (!isFastDropping) return;
      isFastDropping = false;
      clearInterval(gameLoop);
      gameLoop = setInterval(gameStep, currentSpeed);
    }

    // ===== TOUCH CONTROLS =====
    boardWrapper.addEventListener('touchstart', (e) => {
      if (!isPlaying || isPaused) return;
      
      e.preventDefault();
      const touch = e.touches[0];
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
      isDragging = false;
      
      // Start hold timer
      holdTimeout = setTimeout(() => {
        isHolding = true;
        enableFastDrop();
      }, 200);
    });

    boardWrapper.addEventListener('touchmove', (e) => {
      if (!isPlaying || isPaused) return;
      
      e.preventDefault();
      const touch = e.touches[0];
      const deltaX = touch.clientX - touchStartX;
      const deltaY = touch.clientY - touchStartY;
      
      if (!isDragging && (Math.abs(deltaX) > 20 || Math.abs(deltaY) > 20)) {
        isDragging = true;
        clearTimeout(holdTimeout);
        isHolding = false;
        
        if (Math.abs(deltaX) > Math.abs(deltaY)) {
          // Horizontal movement
          if (deltaX > 0) {
            movePiece(1, 0);
          } else {
            movePiece(-1, 0);
          }
        } else if (deltaY > 0) {
          // Downward movement
          movePiece(0, 1);
        }
        
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
      }
    });

    boardWrapper.addEventListener('touchend', (e) => {
      if (!isPlaying || isPaused) return;
      
      e.preventDefault();
      clearTimeout(holdTimeout);
      
      if (isHolding) {
        disableFastDrop();
        isHolding = false;
      } else if (!isDragging) {
        // Tap to rotate
        rotatePiece();
      }
      
      isDragging = false;
    });

    // ===== MOBILE PLAY/PAUSE BUTTON =====
    mobilePlayPause.addEventListener('click', (e) => {
      e.stopPropagation();
      pauseGame();
    });

    // ===== KEYBOARD CONTROLS =====
    document.addEventListener('keydown', (e) => {
      if ((e.key.toLowerCase() === 'p' || e.key === 'Enter') && !e.shiftKey && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        pauseGame();
        return;
      }

      if (e.key.toLowerCase() === 'r' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        startGame();
        return;
      }

      if (e.key.toLowerCase() === 't' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        toggleProgressiveSpeed();
        return;
      }

      if (!isPlaying || isPaused) return;
      
      if (e.key.toLowerCase() === 'a' || e.key === 'ArrowLeft') {
        e.preventDefault();
        movePiece(-1, 0);
      }
      
      if (e.key.toLowerCase() === 'd' || e.key === 'ArrowRight') {
        e.preventDefault();
        movePiece(1, 0);
      }
      
      if (e.key.toLowerCase() === 'w' || e.key.toLowerCase() === 'f' || e.key === 'ArrowUp') {
        e.preventDefault();
        rotatePiece();
      }
      
      if (e.key.toLowerCase() === 's' || e.key === 'ArrowDown') {
        e.preventDefault();
        enableFastDrop();
      }
      
      if (e.key === ' ') {
        e.preventDefault();
        dropPiece();
      }
    });

    document.addEventListener('keyup', (e) => {
      if (e.key.toLowerCase() === 's' || e.key === 'ArrowDown') {
        disableFastDrop();
      }
    });

    // ===== GAME OVER BUTTONS =====
    playAgainBtn.addEventListener('click', () => {
      gameOverOverlay.classList.remove('show');
      startGame();
    });

    closeBtn.addEventListener('click', () => {
      gameOverOverlay.classList.remove('show');
      scheduleHeightCheck();
    });

    speedToggle.addEventListener('click', toggleProgressiveSpeed);

    // ===== INITIALIZE =====
    initBoard();
    initNextPieceBoard();
    updateStats();
    updateGameStatus();

    // ===== FOURTHWALL SCROLLBAR FIX =====
    let lastHeight = 0;
    let resizeTimer;

    function sendHeight() {
      const height = document.body.scrollHeight;
      
      if (height !== lastHeight) {
        lastHeight = height;
        window.parent.postMessage({ frameHeight: height }, '*');
      }
    }

    function scheduleHeightCheck() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(sendHeight, 150);
    }

    window.addEventListener('load', () => {
      setTimeout(sendHeight, 100);
    });

    window.addEventListener('resize', () => {
      scheduleHeightCheck();
    });
    // ===== END OF SCROLLBAR FIX =====
  </script>
</body>
</html>
