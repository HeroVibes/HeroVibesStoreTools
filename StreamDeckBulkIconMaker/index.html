<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stream Deck Icon Builder</title>
  <style>
    :root {
      --bg: #191919;
      --card-bg: #1F1F1F;
      --hover: #323232;
      --outline: #323232;
      --accent: #87A9FF;
      --text-primary: #D4D4D4;
      --text-secondary: #8C8C8C;
      --radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--text-primary);
      font-family: sans-serif;
      padding: 24px 16px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* ===== SECTION HEADERS ===== */
    .section-header {
      font-size: 20px;
      font-weight: bold;
      color: var(--text-primary);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--outline);
    }

    /* ===== MAIN LAYOUT ===== */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 16px;
      margin-bottom: 16px;
    }

    /* ===== LEFT COLUMN: ICON LIBRARY ===== */
    .icon-library {
      background: var(--card-bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 24px 16px;
    }

    .search-wrapper {
      position: relative;
      margin-bottom: 16px;
    }

    .search-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      color: var(--text-primary);
      padding: 12px 16px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .search-input:focus {
      border-color: var(--accent);
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    .upload-section {
      margin-bottom: 16px;
      padding: 16px;
      background: var(--bg);
      border: 2px dashed var(--outline);
      border-radius: var(--radius);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-section:hover {
      border-color: var(--accent);
      background: var(--hover);
    }

    .upload-label {
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    #icon-file-input {
      display: none;
    }

    .selection-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .icon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 8px;
      max-height: 500px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .icon-grid::-webkit-scrollbar {
      width: 8px;
    }

    .icon-grid::-webkit-scrollbar-track {
      background: var(--bg);
      border-radius: 4px;
    }

    .icon-grid::-webkit-scrollbar-thumb {
      background: var(--outline);
      border-radius: 4px;
    }

    .icon-grid::-webkit-scrollbar-thumb:hover {
      background: var(--hover);
    }

    .icon-card {
      background: var(--bg);
      border: 2px solid var(--outline);
      border-radius: var(--radius);
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      position: relative;
    }

    .icon-card:hover {
      background: var(--hover);
      transform: translateY(-2px);
    }

    .icon-card.selected {
      border-color: var(--accent);
      background: var(--hover);
    }

    .icon-card.selected::after {
      content: '‚úì';
      position: absolute;
      top: 6px;
      right: 6px;
      width: 20px;
      height: 20px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--bg);
      font-weight: bold;
    }

    .icon-preview {
      width: 36px;
      height: 36px;
      filter: brightness(0) invert(1);
      object-fit: contain;
    }

    .icon-name {
      font-size: 10px;
      color: var(--text-secondary);
      text-align: center;
      word-break: break-word;
      line-height: 1.2;
    }

    .empty-state {
      text-align: center;
      padding: 48px 16px;
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ===== RIGHT COLUMN: CUSTOMIZATION PANEL ===== */
    .customization-panel {
      background: var(--card-bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .preview-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .preview-canvas-wrapper {
      background: var(--bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-canvas {
      display: block;
      max-width: 100%;
      height: auto;
      border-radius: 12px;
    }

    .control-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .control-label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .control-input {
      background: var(--bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      color: var(--text-primary);
      padding: 8px 12px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    .control-input:focus {
      border-color: var(--accent);
    }

    .color-picker-group {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .color-input {
      width: 60px;
      height: 38px;
      background: var(--bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      cursor: pointer;
      padding: 4px;
    }

    .range-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .range-input {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 6px;
      background: var(--bg);
      border-radius: 3px;
      outline: none;
    }

    .range-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }

    .range-input::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    .range-value {
      min-width: 40px;
      text-align: right;
      font-size: 12px;
      color: var(--text-secondary);
    }

    select.control-input {
      cursor: pointer;
    }

    .preset-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .preset-option {
      aspect-ratio: 16/9;
      border: 2px solid var(--outline);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
      background-size: cover;
      background-position: center;
      position: relative;
      overflow: hidden;
    }

    .preset-option:hover {
      border-color: var(--hover);
      transform: scale(1.05);
    }

    .preset-option.selected {
      border-color: var(--accent);
    }

    .preset-option.selected::after {
      content: '‚úì';
      position: absolute;
      top: 4px;
      right: 4px;
      width: 16px;
      height: 16px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--bg);
      font-weight: bold;
    }

    .texture-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }

    .texture-option {
      aspect-ratio: 1;
      border: 2px solid var(--outline);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
      background-size: cover;
      background-position: center;
    }

    .texture-option:hover {
      border-color: var(--hover);
    }

    .texture-option.selected {
      border-color: var(--accent);
    }

    .texture-none {
      background: linear-gradient(45deg, var(--bg) 25%, var(--outline) 25%, var(--outline) 50%, var(--bg) 50%, var(--bg) 75%, var(--outline) 75%);
      background-size: 8px 8px;
    }

    /* ===== BUTTONS ===== */
    .btn {
      position: relative;
      padding: 10px 16px;
      border-radius: var(--radius);
      background: var(--card-bg);
      color: var(--text-primary);
      border: 1px solid rgba(255,255,255,0.06);
      cursor: pointer;
      overflow: hidden;
      font-size: 14px;
      font-family: sans-serif;
      transition: all 0.2s;
      text-align: center;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 75%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
      transform: skewX(-25deg);
      transition: left 0.7s ease-in-out;
    }

    .btn:hover::before {
      left: 125%;
    }

    .btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(135,169,255,0.12);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg);
      font-weight: bold;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    /* ===== SELECTION BAR ===== */
    .selection-bar {
      background: var(--card-bg);
      border: 1px solid var(--outline);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .selection-info {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .selection-count {
      color: var(--accent);
      font-weight: bold;
    }

    .selection-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* ===== MOBILE OPTIMIZATION ===== */
    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }

      .customization-panel {
        order: -1;
      }

      .icon-grid {
        max-height: 400px;
      }

      .preset-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      body {
        padding: 16px 12px;
      }

      .icon-library,
      .customization-panel {
        padding: 16px 12px;
      }

      .icon-grid {
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        max-height: 300px;
      }

      .icon-preview {
        width: 28px;
        height: 28px;
      }

      .texture-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      .btn-group {
        grid-template-columns: 1fr;
      }

      .selection-actions {
        width: 100%;
      }

      .selection-actions .btn {
        flex: 1;
      }

      .preset-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ===== MAIN LAYOUT ===== -->
    <div class="main-layout">
      <!-- ===== LEFT: ICON LIBRARY ===== -->
      <div class="icon-library">
        <div class="section-header">Icon Library</div>
        
        <!-- ===== UPLOAD SECTION ===== -->
        <div class="upload-section" onclick="document.getElementById('icon-file-input').click()">
          <div class="upload-label">üìÅ Click to upload custom icons (PNG, JPG, SVG)</div>
          <input type="file" id="icon-file-input" accept="image/png,image/jpeg,image/svg+xml" multiple>
        </div>

        <!-- ===== SELECTION CONTROLS ===== -->
        <div class="selection-controls">
          <button class="btn btn-small" id="select-all-btn">Select All</button>
          <button class="btn btn-small" id="deselect-all-btn">Deselect All</button>
        </div>

        <div class="search-wrapper">
          <input 
            type="text" 
            id="search-input" 
            class="search-input" 
            placeholder="Search icons..."
          >
        </div>
        <div id="icon-grid" class="icon-grid"></div>
        <div id="empty-state" class="empty-state" style="display: none;">
          No icons found matching your search.
        </div>
      </div>

      <!-- ===== RIGHT: CUSTOMIZATION PANEL ===== -->
      <div class="customization-panel">
        <div class="section-header">Customize Icon</div>
        
        <!-- ===== PREVIEW ===== -->
        <div class="preview-section">
          <div class="preview-canvas-wrapper">
            <canvas id="preview-canvas" class="preview-canvas" width="256" height="256"></canvas>
          </div>
        </div>

        <!-- ===== SIZE CONTROL ===== -->
        <div class="control-section">
          <div class="control-group">
            <label class="control-label">Output Size (px)</label>
            <select id="size-select" class="control-input">
              <option value="72">72 √ó 72</option>
              <option value="144">144 √ó 144</option>
              <option value="256" selected>256 √ó 256</option>
              <option value="512">512 √ó 512</option>
              <option value="1024">1024 √ó 1024</option>
            </select>
          </div>
        </div>

        <!-- ===== BACKGROUND CONTROLS ===== -->
        <div class="control-section">
          <div class="control-group">
            <label class="control-label">Background Type</label>
            <select id="bg-type" class="control-input">
              <option value="solid">Solid Color</option>
              <option value="gradient">Gradient</option>
              <option value="preset">Preset Gradient</option>
            </select>
          </div>

          <div id="solid-color-controls">
            <div class="control-group">
              <label class="control-label">Background Color</label>
              <div class="color-picker-group">
                <input type="text" id="bg-color-text" class="control-input" value="#000000">
                <input type="color" id="bg-color" class="color-input" value="#000000">
              </div>
            </div>
          </div>

          <div id="gradient-controls" style="display: none;">
            <div class="control-group">
              <label class="control-label">Gradient Color 1</label>
              <div class="color-picker-group">
                <input type="text" id="grad-color1-text" class="control-input" value="#1a1a2e">
                <input type="color" id="grad-color1" class="color-input" value="#1a1a2e">
              </div>
            </div>
            <div class="control-group">
              <label class="control-label">Gradient Color 2</label>
              <div class="color-picker-group">
                <input type="text" id="grad-color2-text" class="control-input" value="#16213e">
                <input type="color" id="grad-color2" class="color-input" value="#16213e">
              </div>
            </div>
            <div class="control-group">
              <label class="control-label">Gradient Angle</label>
              <div class="range-group">
                <input type="range" id="grad-angle" class="range-input" min="0" max="360" value="135">
                <span class="range-value" id="grad-angle-value">135¬∞</span>
              </div>
            </div>
          </div>

          <div id="preset-controls" style="display: none;">
            <div class="control-group">
              <label class="control-label">Preset Gradients</label>
              <div class="preset-grid" id="preset-grid"></div>
            </div>
          </div>
        </div>

        <!-- ===== ICON CONTROLS ===== -->
        <div class="control-section">
          <div class="control-group">
            <label class="control-label">Icon Color</label>
            <div class="color-picker-group">
              <input type="text" id="icon-color-text" class="control-input" value="#FFFFFF">
              <input type="color" id="icon-color" class="color-input" value="#FFFFFF">
            </div>
          </div>

          <div class="control-group">
            <label class="control-label">Icon Size</label>
            <div class="range-group">
              <input type="range" id="icon-scale" class="range-input" min="30" max="90" value="60">
              <span class="range-value" id="icon-scale-value">60%</span>
            </div>
          </div>
        </div>

        <!-- ===== TEXTURE OVERLAY ===== -->
        <div class="control-section">
          <div class="control-group">
            <label class="control-label">Texture Overlay</label>
            <div class="texture-grid" id="texture-grid">
              <div class="texture-option texture-none selected" data-texture="none" title="None"></div>
            </div>
          </div>

          <div class="control-group" id="texture-opacity-group" style="display: none;">
            <label class="control-label">Texture Opacity</label>
            <div class="range-group">
              <input type="range" id="texture-opacity" class="range-input" min="0" max="100" value="20">
              <span class="range-value" id="texture-opacity-value">20%</span>
            </div>
          </div>
        </div>

        <!-- ===== CORNER ROUNDING ===== -->
        <div class="control-section">
          <div class="control-group">
            <label class="control-label">Corner Radius</label>
            <div class="range-group">
              <input type="range" id="corner-radius" class="range-input" min="0" max="50" value="16">
              <span class="range-value" id="corner-radius-value">16%</span>
            </div>
          </div>
        </div>

        <!-- ===== ACTION BUTTONS ===== -->
        <div class="btn-group">
          <button class="btn" id="add-to-batch-btn" disabled>Add to Batch</button>
          <button class="btn btn-primary" id="download-single-btn" disabled>Download</button>
        </div>
      </div>
    </div>

    <!-- ===== SELECTION BAR ===== -->
    <div class="selection-bar">
      <div class="selection-info">
        <span class="selection-count" id="selection-count">0</span> icons in batch
      </div>
      <div class="selection-actions">
        <button class="btn" id="clear-batch-btn">Clear Batch</button>
        <button class="btn btn-primary" id="download-batch-btn" disabled>Download Batch (.zip)</button>
      </div>
    </div>
  </div>

  <!-- Include JSZip library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    // ===== ICON DATABASE =====
    const builtInIcons = [
      { name: 'Adobe Acrobat', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/adobe-acrobat.svg', keywords: ['adobe', 'acrobat', 'pdf', 'document', 'reader'], builtin: true },
      { name: 'Adobe Illustrator', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/adobe-illustrator.svg', keywords: ['adobe', 'illustrator', 'vector', 'design', 'graphics', 'ai'], builtin: true },
      { name: 'Adobe Lightroom', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/adobe-lightroom.svg', keywords: ['adobe', 'lightroom', 'photo', 'editing', 'photography', 'lr'], builtin: true },
      { name: 'Adobe Photoshop', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/adobe-photoshop.svg', keywords: ['adobe', 'photoshop', 'photo', 'editing', 'graphics', 'ps'], builtin: true },
      { name: 'Adobe Premiere Pro', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/adobe-premiere-pro.svg', keywords: ['adobe', 'premiere', 'video', 'editing', 'film', 'pr'], builtin: true },
      { name: 'Amazon', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/amazon.svg', keywords: ['amazon', 'shopping', 'ecommerce', 'online', 'store'], builtin: true },
      { name: 'Arrow Down', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/arrow-down.svg', keywords: ['arrow', 'down', 'direction', 'navigate', 'point'], builtin: true },
      { name: 'Arrow Left', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/arrow-left.svg', keywords: ['arrow', 'left', 'direction', 'navigate', 'back', 'previous'], builtin: true },
      { name: 'Arrow Right', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/arrow-right.svg', keywords: ['arrow', 'right', 'direction', 'navigate', 'forward', 'next'], builtin: true },
      { name: 'Arrow Up', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/arrow-up.svg', keywords: ['arrow', 'up', 'direction', 'navigate', 'point'], builtin: true },
      { name: 'Arrows Horizontal', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/arrows-h.svg', keywords: ['arrow', 'horizontal', 'dual', 'left', 'right', 'bidirectional', 'swap'], builtin: true },
      { name: 'Arrows Spin', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/arrows-spin.svg', keywords: ['arrow', 'spin', 'rotate', 'refresh', 'reload', 'cycle'], builtin: true },
      { name: 'Arrows All', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/arrows.svg', keywords: ['arrow', 'all', 'directions', 'navigate', 'move', 'expand'], builtin: true },
      { name: 'Calendar', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/calendar.svg', keywords: ['calendar', 'date', 'schedule', 'time', 'event', 'planner'], builtin: true },
      { name: 'Discord', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/discord.svg', keywords: ['discord', 'chat', 'voice', 'gaming', 'community', 'social'], builtin: true },
      { name: 'Download', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/download.svg', keywords: ['download', 'save', 'get', 'arrow', 'import'], builtin: true },
      { name: 'Elgato', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/elgato.svg', keywords: ['elgato', 'stream', 'deck', 'gaming', 'streaming', 'capture'], builtin: true },
      { name: 'Facebook', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/facebook.svg', keywords: ['facebook', 'social', 'media', 'meta', 'network'], builtin: true },
      { name: 'Google Drive', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/google-drive.svg', keywords: ['google', 'drive', 'cloud', 'storage', 'files', 'docs'], builtin: true },
      { name: 'Google', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/google.svg', keywords: ['google', 'search', 'browser', 'web', 'internet'], builtin: true },
      { name: 'Instagram', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/instagram.svg', keywords: ['instagram', 'social', 'media', 'photo', 'sharing', 'meta'], builtin: true },
      { name: 'Reddit', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/reddit.svg', keywords: ['reddit', 'social', 'community', 'forum', 'discussion'], builtin: true },
      { name: 'Safari', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/safari.svg', keywords: ['safari', 'browser', 'web', 'apple', 'internet'], builtin: true },
      { name: 'Text', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/text.svg', keywords: ['text', 'font', 'type', 'letter', 't', 'typography'], builtin: true },
      { name: 'TikTok', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/tiktok.svg', keywords: ['tiktok', 'social', 'media', 'video', 'short', 'entertainment'], builtin: true },
      { name: 'Twitch', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/twitch.svg', keywords: ['twitch', 'streaming', 'gaming', 'live', 'broadcast', 'stream'], builtin: true },
      { name: 'X (Twitter)', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/x-twitter.svg', keywords: ['x', 'twitter', 'social', 'media', 'tweet', 'post'], builtin: true },
      { name: 'YouTube', url: 'https://herovibes.github.io/HeroVibesStoreTools/StreamDeckBulkIconMaker/Images/youtube.svg', keywords: ['youtube', 'video', 'streaming', 'google', 'content', 'creator'], builtin: true }
    ];

    // ===== TEXTURE DATABASE =====
    const textures = [
      { name: 'Noise', url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuOSIgbnVtT2N0YXZlcz0iNCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbHRlcj0idXJsKCNub2lzZSkiLz48L3N2Zz4=' },
      { name: 'Dots', url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiNmZmYiLz48L3N2Zz4=' },
      { name: 'Grid', url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTAgMGg0MHY0MEgweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0wIDBoNDB2MVYwek0wIDBoMXY0MEgweiIgZmlsbD0iI2ZmZiIgb3BhY2l0eT0iLjEiLz48L3N2Zz4=' },
      { name: 'Diagonal Lines', url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTAgNDBMNDAgME00MCA0MEw4MCAwTTAgMEwtNDAgNDAiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxIiBvcGFjaXR5PSIwLjEiLz48L3N2Zz4=' },
      { name: 'Carbon Fiber', url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNiIgaGVpZ2h0PSI2IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI2IiBoZWlnaHQ9IjYiIGZpbGw9IiMxYTFhMWEiLz48Y2lyY2xlIGN4PSIzIiBjeT0iMyIgcj0iMSIgZmlsbD0iIzMzMyIvPjwvc3ZnPg==' },
      { name: 'Hexagons', url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTYiIGhlaWdodD0iMTAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0yOCAwTDU2IDE2LjFWNDcuOUwyOCA2NEwwIDQ3LjlWMTYuMXoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxIiBvcGFjaXR5PSIwLjA1Ii8+PC9zdmc+' }
    ];

    // ===== GRADIENT PRESETS =====
    const gradientPresets = [
      { name: 'Sunset', colors: ['#FF512F', '#DD2476'], angle: 135 },
      { name: 'Ocean', colors: ['#2E3192', '#1BFFFF'], angle: 135 },
      { name: 'Purple Haze', colors: ['#360033', '#0b8793'], angle: 135 },
      { name: 'Fire', colors: ['#f12711', '#f5af19'], angle: 45 },
      { name: 'Ice', colors: ['#00d2ff', '#3a7bd5'], angle: 135 },
      { name: 'Forest', colors: ['#134E5E', '#71B280'], angle: 135 },
      { name: 'Royal', colors: ['#141E30', '#243B55'], angle: 135 },
      { name: 'Peach', colors: ['#ED4264', '#FFEDBC'], angle: 135 },
      { name: 'Aqua', colors: ['#13547a', '#80d0c7'], angle: 135 },
      { name: 'Neon', colors: ['#7F00FF', '#E100FF'], angle: 135 },
      { name: 'Candy', colors: ['#D38312', '#A83279'], angle: 135 },
      { name: 'Midnight', colors: ['#232526', '#414345'], angle: 135 }
    ];

    // ===== STATE =====
    let icons = [...builtInIcons];
    let selectedIcons = new Set();
    let filteredIcons = [...icons];
    let batchIcons = [];
    let loadedTextures = {};

    // ===== SETTINGS STATE =====
    const settings = {
      size: 256,
      bgType: 'solid',
      bgColor: '#000000',
      gradColor1: '#1a1a2e',
      gradColor2: '#16213e',
      gradAngle: 135,
      presetGradient: null,
      iconColor: '#FFFFFF',
      iconScale: 60,
      texture: 'none',
      textureOpacity: 20,
      cornerRadius: 16
    };

    // ===== DOM ELEMENTS =====
    const searchInput = document.getElementById('search-input');
    const iconGrid = document.getElementById('icon-grid');
    const emptyState = document.getElementById('empty-state');
    const previewCanvas = document.getElementById('preview-canvas');
    const ctx = previewCanvas.getContext('2d');
    const iconFileInput = document.getElementById('icon-file-input');

    // Controls
    const sizeSelect = document.getElementById('size-select');
    const bgType = document.getElementById('bg-type');
    const bgColorText = document.getElementById('bg-color-text');
    const bgColor = document.getElementById('bg-color');
    const gradColor1Text = document.getElementById('grad-color1-text');
    const gradColor1 = document.getElementById('grad-color1');
    const gradColor2Text = document.getElementById('grad-color2-text');
    const gradColor2 = document.getElementById('grad-color2');
    const gradAngle = document.getElementById('grad-angle');
    const gradAngleValue = document.getElementById('grad-angle-value');
    const iconColorText = document.getElementById('icon-color-text');
    const iconColor = document.getElementById('icon-color');
    const iconScale = document.getElementById('icon-scale');
    const iconScaleValue = document.getElementById('icon-scale-value');
    const textureGrid = document.getElementById('texture-grid');
    const textureOpacity = document.getElementById('texture-opacity');
    const textureOpacityValue = document.getElementById('texture-opacity-value');
    const textureOpacityGroup = document.getElementById('texture-opacity-group');
    const cornerRadius = document.getElementById('corner-radius');
    const cornerRadiusValue = document.getElementById('corner-radius-value');
    const solidColorControls = document.getElementById('solid-color-controls');
    const gradientControls = document.getElementById('gradient-controls');
    const presetControls = document.getElementById('preset-controls');
    const presetGrid = document.getElementById('preset-grid');

    // Buttons
    const selectAllBtn = document.getElementById('select-all-btn');
    const deselectAllBtn = document.getElementById('deselect-all-btn');
    const addToBatchBtn = document.getElementById('add-to-batch-btn');
    const downloadSingleBtn = document.getElementById('download-single-btn');
    const clearBatchBtn = document.getElementById('clear-batch-btn');
    const downloadBatchBtn = document.getElementById('download-batch-btn');
    const selectionCount = document.getElementById('selection-count');

    // ===== INITIALIZE =====
    function init() {
      renderIconGrid();
      renderTextureGrid();
      renderPresetGrid();
      setupEventListeners();
      updatePreview();
      preloadTextures();
    }

    // ===== RENDER ICON GRID =====
    function renderIconGrid() {
      iconGrid.innerHTML = '';
      
      if (filteredIcons.length === 0) {
        iconGrid.style.display = 'none';
        emptyState.style.display = 'block';
        scheduleHeightCheck();
        return;
      }

      iconGrid.style.display = 'grid';
      emptyState.style.display = 'none';

      filteredIcons.forEach(icon => {
        const card = document.createElement('div');
        card.className = 'icon-card';
        if (selectedIcons.has(icon.url)) {
          card.classList.add('selected');
        }
        
        card.innerHTML = `
          <img src="${icon.url}" alt="${icon.name}" class="icon-preview" style="${icon.builtin ? '' : 'filter: none;'}">
          <div class="icon-name">${icon.name}</div>
        `;
        
        card.addEventListener('click', () => toggleIconSelection(icon, card));
        iconGrid.appendChild(card);
      });

      scheduleHeightCheck();
    }

    // ===== RENDER TEXTURE GRID =====
    function renderTextureGrid() {
      textures.forEach(texture => {
        const option = document.createElement('div');
        option.className = 'texture-option';
        option.dataset.texture = texture.name.toLowerCase();
        option.style.backgroundImage = `url(${texture.url})`;
        option.title = texture.name;
        
        option.addEventListener('click', () => selectTexture(texture.name.toLowerCase(), option));
        textureGrid.appendChild(option);
      });
    }

    // ===== RENDER PRESET GRID =====
    function renderPresetGrid() {
      gradientPresets.forEach((preset, index) => {
        const option = document.createElement('div');
        option.className = 'preset-option';
        option.dataset.preset = index;
        option.title = preset.name;
        
        const angle = preset.angle;
        option.style.background = `linear-gradient(${angle}deg, ${preset.colors[0]}, ${preset.colors[1]})`;
        
        option.addEventListener('click', () => selectPreset(index, option));
        presetGrid.appendChild(option);
      });
    }

    // ===== SELECT PRESET =====
    function selectPreset(index, element) {
      const preset = gradientPresets[index];
      settings.presetGradient = index;
      settings.gradColor1 = preset.colors[0];
      settings.gradColor2 = preset.colors[1];
      settings.gradAngle = preset.angle;
      
      gradColor1.value = preset.colors[0];
      gradColor1Text.value = preset.colors[0];
      gradColor2.value = preset.colors[1];
      gradColor2Text.value = preset.colors[1];
      gradAngle.value = preset.angle;
      gradAngleValue.textContent = preset.angle + '¬∞';
      
      document.querySelectorAll('.preset-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      element.classList.add('selected');
      
      updatePreview();
    }

    // ===== TOGGLE ICON SELECTION =====
    function toggleIconSelection(icon, card) {
      if (selectedIcons.has(icon.url)) {
        selectedIcons.delete(icon.url);
        card.classList.remove('selected');
      } else {
        selectedIcons.add(icon.url);
        card.classList.add('selected');
      }
      updateSelectionUI();
      
      // Update preview with first selected icon
      if (selectedIcons.size > 0) {
        const firstSelectedUrl = Array.from(selectedIcons)[0];
        const firstIcon = icons.find(i => i.url === firstSelectedUrl);
        updatePreviewWithIcon(firstIcon);
      } else {
        updatePreview();
      }
    }

    // ===== SELECT TEXTURE =====
    function selectTexture(textureName, element) {
      settings.texture = textureName;
      
      document.querySelectorAll('.texture-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      element.classList.add('selected');

      textureOpacityGroup.style.display = textureName === 'none' ? 'none' : 'flex';
      
      updatePreview();
    }

    // ===== PRELOAD TEXTURES =====
    async function preloadTextures() {
      for (const texture of textures) {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        await new Promise((resolve) => {
          img.onload = resolve;
          img.onerror = resolve;
          img.src = texture.url;
        });
        loadedTextures[texture.name.toLowerCase()] = img;
      }
    }

    // ===== UPDATE PREVIEW WITH ICON =====
    async function updatePreviewWithIcon(icon) {
      const size = 256;
      const radiusPx = (size * settings.cornerRadius) / 100;

      ctx.clearRect(0, 0, size, size);
      ctx.save();
      
      // Create rounded rectangle path
      ctx.beginPath();
      ctx.moveTo(radiusPx, 0);
      ctx.lineTo(size - radiusPx, 0);
      ctx.quadraticCurveTo(size, 0, size, radiusPx);
      ctx.lineTo(size, size - radiusPx);
      ctx.quadraticCurveTo(size, size, size - radiusPx, size);
      ctx.lineTo(radiusPx, size);
      ctx.quadraticCurveTo(0, size, 0, size - radiusPx);
      ctx.lineTo(0, radiusPx);
      ctx.quadraticCurveTo(0, 0, radiusPx, 0);
      ctx.closePath();
      ctx.clip();

      // Draw background
      if (settings.bgType === 'solid') {
        ctx.fillStyle = settings.bgColor;
        ctx.fillRect(0, 0, size, size);
      } else {
        const angle = (settings.gradAngle * Math.PI) / 180;
        const x1 = size / 2 - Math.cos(angle) * size / 2;
        const y1 = size / 2 - Math.sin(angle) * size / 2;
        const x2 = size / 2 + Math.cos(angle) * size / 2;
        const y2 = size / 2 + Math.sin(angle) * size / 2;
        
        const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
        gradient.addColorStop(0, settings.gradColor1);
        gradient.addColorStop(1, settings.gradColor2);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, size, size);
      }

      // Draw texture overlay
      if (settings.texture !== 'none' && loadedTextures[settings.texture]) {
        ctx.globalAlpha = settings.textureOpacity / 100;
        const pattern = ctx.createPattern(loadedTextures[settings.texture], 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, size, size);
        ctx.globalAlpha = 1;
      }

      ctx.restore();

      // Draw icon
      if (icon) {
        try {
          const response = await fetch(icon.url);
          const blob = await response.blob();
          const isBuiltIn = icon.builtin;
          
          if (blob.type === 'image/svg+xml' && isBuiltIn) {
            // For built-in SVGs, apply color modification
            const svgText = await blob.text();
            let modifiedSvg = svgText.replace(/fill="[^"]*"/g, `fill="${settings.iconColor}"`);
            modifiedSvg = modifiedSvg.replace(/stroke="[^"]*"/g, `stroke="${settings.iconColor}"`);
            if (!modifiedSvg.includes('fill=')) {
              modifiedSvg = modifiedSvg.replace('<svg', `<svg fill="${settings.iconColor}"`);
            }
            
            const img = new Image();
            const svgBlob = new Blob([modifiedSvg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(svgBlob);
            
            await new Promise((resolve, reject) => {
              img.onload = resolve;
              img.onerror = reject;
              img.src = url;
            });
            
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(radiusPx, 0);
            ctx.lineTo(size - radiusPx, 0);
            ctx.quadraticCurveTo(size, 0, size, radiusPx);
            ctx.lineTo(size, size - radiusPx);
            ctx.quadraticCurveTo(size, size, size - radiusPx, size);
            ctx.lineTo(radiusPx, size);
            ctx.quadraticCurveTo(0, size, 0, size - radiusPx);
            ctx.lineTo(0, radiusPx);
            ctx.quadraticCurveTo(0, 0, radiusPx, 0);
            ctx.closePath();
            ctx.clip();
            
            const iconSize = (size * settings.iconScale) / 100;
            const iconX = (size - iconSize) / 2;
            const iconY = (size - iconSize) / 2;
            
            ctx.drawImage(img, iconX, iconY, iconSize, iconSize);
            ctx.restore();
            URL.revokeObjectURL(url);
          } else {
            // For custom uploads (PNG/JPG), draw as-is
            const img = new Image();
            const url = URL.createObjectURL(blob);
            
            await new Promise((resolve, reject) => {
              img.onload = resolve;
              img.onerror = reject;
              img.src = url;
            });
            
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(radiusPx, 0);
            ctx.lineTo(size - radiusPx, 0);
            ctx.quadraticCurveTo(size, 0, size, radiusPx);
            ctx.lineTo(size, size - radiusPx);
            ctx.quadraticCurveTo(size, size, size - radiusPx, size);
            ctx.lineTo(radiusPx, size);
            ctx.quadraticCurveTo(0, size, 0, size - radiusPx);
            ctx.lineTo(0, radiusPx);
            ctx.quadraticCurveTo(0, 0, radiusPx, 0);
            ctx.closePath();
            ctx.clip();
            
            const iconSize = (size * settings.iconScale) / 100;
            const iconX = (size - iconSize) / 2;
            const iconY = (size - iconSize) / 2;
            
            ctx.drawImage(img, iconX, iconY, iconSize, iconSize);
            ctx.restore();
            URL.revokeObjectURL(url);
          }
        } catch (error) {
          console.error('Error drawing icon:', error);
        }
      }
    }

    // ===== UPDATE PREVIEW =====
    async function updatePreview() {
      const firstSelectedUrl = selectedIcons.size > 0 ? Array.from(selectedIcons)[0] : null;
      const icon = firstSelectedUrl ? icons.find(i => i.url === firstSelectedUrl) : null;
      
      if (!icon) {
        const size = 256;
        ctx.fillStyle = '#0a0a0a';
        ctx.fillRect(0, 0, size, size);
        ctx.fillStyle = '#666';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Select an icon', size/2, size/2);
        return;
      }

      await updatePreviewWithIcon(icon);
    }

    // ===== GENERATE ICON =====
    async function generateIcon(icon, outputSize) {
      const canvas = document.createElement('canvas');
      canvas.width = outputSize;
      canvas.height = outputSize;
      const ctx = canvas.getContext('2d');
      
      const radiusPx = (outputSize * settings.cornerRadius) / 100;

      ctx.save();
      // Create rounded rectangle path
      ctx.beginPath();
      ctx.moveTo(radiusPx, 0);
      ctx.lineTo(outputSize - radiusPx, 0);
      ctx.quadraticCurveTo(outputSize, 0, outputSize, radiusPx);
      ctx.lineTo(outputSize, outputSize - radiusPx);
      ctx.quadraticCurveTo(outputSize, outputSize, outputSize - radiusPx, outputSize);
      ctx.lineTo(radiusPx, outputSize);
      ctx.quadraticCurveTo(0, outputSize, 0, outputSize - radiusPx);
      ctx.lineTo(0, radiusPx);
      ctx.quadraticCurveTo(0, 0, radiusPx, 0);
      ctx.closePath();
      ctx.clip();

      // Draw background
      if (settings.bgType === 'solid') {
        ctx.fillStyle = settings.bgColor;
        ctx.fillRect(0, 0, outputSize, outputSize);
      } else {
        const angle = (settings.gradAngle * Math.PI) / 180;
        const x1 = outputSize / 2 - Math.cos(angle) * outputSize / 2;
        const y1 = outputSize / 2 - Math.sin(angle) * outputSize / 2;
        const x2 = outputSize / 2 + Math.cos(angle) * outputSize / 2;
        const y2 = outputSize / 2 + Math.sin(angle) * outputSize / 2;
        
        const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
        gradient.addColorStop(0, settings.gradColor1);
        gradient.addColorStop(1, settings.gradColor2);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, outputSize, outputSize);
      }

      // Draw texture overlay
      if (settings.texture !== 'none' && loadedTextures[settings.texture]) {
        ctx.globalAlpha = settings.textureOpacity / 100;
        const pattern = ctx.createPattern(loadedTextures[settings.texture], 'repeat');
        ctx.fillStyle = pattern;
        ctx.fillRect(0, 0, outputSize, outputSize);
        ctx.globalAlpha = 1;
      }

      ctx.restore();

      // Draw icon
      const response = await fetch(icon.url);
      const blob = await response.blob();
      const isBuiltIn = icon.builtin;
      
      if (blob.type === 'image/svg+xml' && isBuiltIn) {
        const svgText = await blob.text();
        let modifiedSvg = svgText.replace(/fill="[^"]*"/g, `fill="${settings.iconColor}"`);
        modifiedSvg = modifiedSvg.replace(/stroke="[^"]*"/g, `stroke="${settings.iconColor}"`);
        if (!modifiedSvg.includes('fill=')) {
          modifiedSvg = modifiedSvg.replace('<svg', `<svg fill="${settings.iconColor}"`);
        }
        
        const img = new Image();
        const svgBlob = new Blob([modifiedSvg], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(svgBlob);
        
        await new Promise((resolve, reject) => {
          img.onload = resolve;
          img.onerror = reject;
          img.src = url;
        });
        
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(radiusPx, 0);
        ctx.lineTo(outputSize - radiusPx, 0);
        ctx.quadraticCurveTo(outputSize, 0, outputSize, radiusPx);
        ctx.lineTo(outputSize, outputSize - radiusPx);
        ctx.quadraticCurveTo(outputSize, outputSize, outputSize - radiusPx, outputSize);
        ctx.lineTo(radiusPx, outputSize);
        ctx.quadraticCurveTo(0, outputSize, 0, outputSize - radiusPx);
        ctx.lineTo(0, radiusPx);
        ctx.quadraticCurveTo(0, 0, radiusPx, 0);
        ctx.closePath();
        ctx.clip();
        
        const iconSize = (outputSize * settings.iconScale) / 100;
        const iconX = (outputSize - iconSize) / 2;
        const iconY = (outputSize - iconSize) / 2;
        
        ctx.drawImage(img, iconX, iconY, iconSize, iconSize);
        ctx.restore();
        URL.revokeObjectURL(url);
      } else {
        const img = new Image();
        const url = URL.createObjectURL(blob);
        
        await new Promise((resolve, reject) => {
          img.onload = resolve;
          img.onerror = reject;
          img.src = url;
        });
        
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(radiusPx, 0);
        ctx.lineTo(outputSize - radiusPx, 0);
        ctx.quadraticCurveTo(outputSize, 0, outputSize, radiusPx);
        ctx.lineTo(outputSize, outputSize - radiusPx);
        ctx.quadraticCurveTo(outputSize, outputSize, outputSize - radiusPx, outputSize);
        ctx.lineTo(radiusPx, outputSize);
        ctx.quadraticCurveTo(0, outputSize, 0, outputSize - radiusPx);
        ctx.lineTo(0, radiusPx);
        ctx.quadraticCurveTo(0, 0, radiusPx, 0);
        ctx.closePath();
        ctx.clip();
        
        const iconSize = (outputSize * settings.iconScale) / 100;
        const iconX = (outputSize - iconSize) / 2;
        const iconY = (outputSize - iconSize) / 2;
        
        ctx.drawImage(img, iconX, iconY, iconSize, iconSize);
        ctx.restore();
        URL.revokeObjectURL(url);
      }

      return canvas;
    }

    // ===== HANDLE FILE UPLOAD =====
    iconFileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      
      for (const file of files) {
        const url = URL.createObjectURL(file);
        const name = file.name.replace(/\.[^/.]+$/, '');
        
        const customIcon = {
          name: name,
          url: url,
          keywords: [name.toLowerCase()],
          builtin: false,
          isCustom: true
        };
        
        icons.push(customIcon);
      }
      
      filteredIcons = [...icons];
      renderIconGrid();
      
      // Clear the input
      e.target.value = '';
    });

    // ===== DOWNLOAD SINGLE ICON =====
    async function downloadSingle() {
      if (selectedIcons.size === 0) return;

      downloadSingleBtn.disabled = true;
      downloadSingleBtn.textContent = 'Generating...';

      try {
        const firstSelectedUrl = Array.from(selectedIcons)[0];
        const icon = icons.find(i => i.url === firstSelectedUrl);
        
        const canvas = await generateIcon(icon, settings.size);
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${icon.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${settings.size}px.png`;
        a.click();
        URL.revokeObjectURL(url);

        downloadSingleBtn.textContent = 'Downloaded!';
        setTimeout(() => {
          downloadSingleBtn.textContent = 'Download';
          downloadSingleBtn.disabled = false;
        }, 1500);
      } catch (error) {
        console.error('Download error:', error);
        downloadSingleBtn.textContent = 'Error';
        setTimeout(() => {
          downloadSingleBtn.textContent = 'Download';
          downloadSingleBtn.disabled = false;
        }, 1500);
      }
    }

    // ===== ADD TO BATCH =====
    function addToBatch() {
      if (selectedIcons.size === 0) return;

      selectedIcons.forEach(iconUrl => {
        const icon = icons.find(i => i.url === iconUrl);
        const batchItem = {
          icon: icon,
          settings: {...settings}
        };
        batchIcons.push(batchItem);
      });

      updateBatchUI();

      addToBatchBtn.textContent = 'Added!';
      setTimeout(() => {
        addToBatchBtn.textContent = 'Add to Batch';
      }, 1000);
    }

    // ===== UPDATE BATCH UI =====
    function updateBatchUI() {
      selectionCount.textContent = batchIcons.length;
      downloadBatchBtn.disabled = batchIcons.length === 0;
      scheduleHeightCheck();
    }

    // ===== UPDATE SELECTION UI =====
    function updateSelectionUI() {
      const hasSelection = selectedIcons.size > 0;
      addToBatchBtn.disabled = !hasSelection;
      downloadSingleBtn.disabled = !hasSelection;
    }

    // ===== CLEAR BATCH =====
    function clearBatch() {
      batchIcons = [];
      updateBatchUI();
    }

    // ===== SELECT ALL =====
    function selectAll() {
      filteredIcons.forEach(icon => selectedIcons.add(icon.url));
      renderIconGrid();
      updateSelectionUI();
      updatePreview();
    }

    // ===== DESELECT ALL =====
    function deselectAll() {
      selectedIcons.clear();
      renderIconGrid();
      updateSelectionUI();
      updatePreview();
    }

    // ===== DOWNLOAD BATCH =====
    async function downloadBatch() {
      if (batchIcons.length === 0) return;

      downloadBatchBtn.disabled = true;
      downloadBatchBtn.textContent = `Generating 0/${batchIcons.length}...`;

      try {
        const zip = new JSZip();

        for (let i = 0; i < batchIcons.length; i++) {
          const item = batchIcons[i];
          
          const originalSettings = {...settings};
          Object.assign(settings, item.settings);
          
          const canvas = await generateIcon(item.icon, item.settings.size);
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
          
          const fileName = `${item.icon.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${item.settings.size}px.png`;
          zip.file(fileName, blob);
          
          Object.assign(settings, originalSettings);
          
          downloadBatchBtn.textContent = `Generating ${i + 1}/${batchIcons.length}...`;
        }

        downloadBatchBtn.textContent = 'Creating ZIP...';
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `stream-deck-icons-${Date.now()}.zip`;
        a.click();
        URL.revokeObjectURL(url);

        downloadBatchBtn.textContent = 'Downloaded!';
        setTimeout(() => {
          downloadBatchBtn.textContent = 'Download Batch (.zip)';
          downloadBatchBtn.disabled = false;
        }, 2000);
      } catch (error) {
        console.error('Batch download error:', error);
        downloadBatchBtn.textContent = 'Error';
        setTimeout(() => {
          downloadBatchBtn.textContent = 'Download Batch (.zip)';
          downloadBatchBtn.disabled = false;
        }, 2000);
      }
    }

    // ===== SETUP EVENT LISTENERS =====
    function setupEventListeners() {
      // Search
      searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        filteredIcons = searchTerm === '' ? [...icons] : 
          icons.filter(icon => 
            icon.name.toLowerCase().includes(searchTerm) ||
            icon.keywords.some(keyword => keyword.toLowerCase().includes(searchTerm))
          );
        renderIconGrid();
      });

      // Size
      sizeSelect.addEventListener('change', (e) => {
        settings.size = parseInt(e.target.value);
      });

      // Background type
      bgType.addEventListener('change', (e) => {
        settings.bgType = e.target.value;
        solidColorControls.style.display = e.target.value === 'solid' ? 'block' : 'none';
        gradientControls.style.display = e.target.value === 'gradient' ? 'block' : 'none';
        presetControls.style.display = e.target.value === 'preset' ? 'block' : 'none';
        updatePreview();
        scheduleHeightCheck();
      });

      // Color inputs
      const syncColorInputs = (colorPicker, textInput, settingKey) => {
        colorPicker.addEventListener('input', (e) => {
          settings[settingKey] = e.target.value;
          textInput.value = e.target.value;
          settings.presetGradient = null;
          document.querySelectorAll('.preset-option').forEach(opt => opt.classList.remove('selected'));
          updatePreview();
        });
        textInput.addEventListener('input', (e) => {
          const value = e.target.value;
          if (/^#[0-9A-F]{6}$/i.test(value)) {
            settings[settingKey] = value;
            colorPicker.value = value;
            settings.presetGradient = null;
            document.querySelectorAll('.preset-option').forEach(opt => opt.classList.remove('selected'));
            updatePreview();
          }
        });
      };

      syncColorInputs(bgColor, bgColorText, 'bgColor');
      syncColorInputs(gradColor1, gradColor1Text, 'gradColor1');
      syncColorInputs(gradColor2, gradColor2Text, 'gradColor2');
      syncColorInputs(iconColor, iconColorText, 'iconColor');

      // Gradient angle
      gradAngle.addEventListener('input', (e) => {
        settings.gradAngle = parseInt(e.target.value);
        gradAngleValue.textContent = settings.gradAngle + '¬∞';
        settings.presetGradient = null;
        document.querySelectorAll('.preset-option').forEach(opt => opt.classList.remove('selected'));
        updatePreview();
      });

      // Icon scale
      iconScale.addEventListener('input', (e) => {
        settings.iconScale = parseInt(e.target.value);
        iconScaleValue.textContent = settings.iconScale + '%';
        updatePreview();
      });

      // Texture opacity
      textureOpacity.addEventListener('input', (e) => {
        settings.textureOpacity = parseInt(e.target.value);
        textureOpacityValue.textContent = settings.textureOpacity + '%';
        updatePreview();
      });

      // Corner radius
      cornerRadius.addEventListener('input', (e) => {
        settings.cornerRadius = parseInt(e.target.value);
        cornerRadiusValue.textContent = settings.cornerRadius + '%';
        updatePreview();
      });

      // Buttons
      selectAllBtn.addEventListener('click', selectAll);
      deselectAllBtn.addEventListener('click', deselectAll);
      downloadSingleBtn.addEventListener('click', downloadSingle);
      addToBatchBtn.addEventListener('click', addToBatch);
      clearBatchBtn.addEventListener('click', clearBatch);
      downloadBatchBtn.addEventListener('click', downloadBatch);
    }

    // ===== INITIALIZE APP =====
    init();

    // ===== FOURTHWALL SCROLLBAR FIX =====
    let lastHeight = 0;
    let resizeTimer;

    function sendHeight() {
      const height = document.body.scrollHeight;
      
      if (height !== lastHeight) {
        lastHeight = height;
        window.parent.postMessage({ frameHeight: height }, '*');
      }
    }

    function scheduleHeightCheck() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(sendHeight, 150);
    }

    window.addEventListener('load', () => {
      setTimeout(sendHeight, 100);
    });

    window.addEventListener('resize', () => {
      scheduleHeightCheck();
    });
    // ===== END OF SCROLLBAR FIX =====
  </script>
</body>
</html>
