<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Circle Timers</title>
  <style>
    /* ===== CSS VARIABLES ===== */
    :root {
      --primary-bg: #191919;
      --secondary-bg: #1F1F1F;
      --hover-color: #323232;
      --outline-color: #323232;
      --accent-color: #87A9FF;
      --primary-text: #D4D4D4;
      --secondary-text: #8C8C8C;
      --radius: 8px;
      --warning-yellow: #FFD700;
      --danger-red: #FF4444;
    }

    /* ===== GLOBAL STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--primary-bg);
      color: var(--primary-text);
      padding: 24px 16px;
      min-height: 100vh;
    }

    /* ===== MAIN CONTAINER ===== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* ===== TIMER ROWS ===== */
    #rows-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .timer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: center;
    }

    /* ===== TIMER CARD ===== */
    .timer {
      background: var(--secondary-bg);
      border: 1px solid var(--outline-color);
      border-radius: var(--radius);
      padding: 16px;
      width: 180px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .timer:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(135, 169, 255, 0.1);
    }

    /* ===== TIMER TITLE ===== */
    .title {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary-text);
      margin-bottom: 12px;
      outline: none;
      cursor: text;
      text-align: center;
      width: 100%;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s ease;
    }

    .title:hover {
      background: rgba(135, 169, 255, 0.05);
    }

    .title:focus {
      background: var(--hover-color);
      border-bottom: 2px solid var(--accent-color);
    }

    /* ===== CIRCLE TIMER ===== */
    .circle-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .circle-container:hover {
      transform: scale(1.05);
    }

    .circle-container:active {
      transform: scale(0.98);
    }

    .progress-ring {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }

    .ring-bg {
      fill: none;
      stroke: var(--hover-color);
      stroke-width: 6;
    }

    .ring {
      fill: none;
      stroke: var(--accent-color);
      stroke-width: 6;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease, stroke 0.3s ease;
    }

    /* Ring pulse animation for start */
    @keyframes ringPulse {
      0%, 100% { 
        stroke-width: 6;
        opacity: 1;
      }
      50% { 
        stroke-width: 10;
        opacity: 0.8;
      }
    }

    .ring.pulse {
      animation: ringPulse 0.6s ease-out;
    }

    .time-display {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: bold;
      color: var(--primary-text);
      user-select: none;
      pointer-events: none;
    }

    /* ===== TIMER CONTROLS ===== */
    .controls {
      display: flex;
      gap: 8px;
      width: 100%;
      justify-content: center;
    }

    .controls button {
      position: relative;
      width: 36px;
      height: 36px;
      padding: 0;
      background: var(--secondary-bg);
      border: 1px solid var(--outline-color);
      color: var(--primary-text);
      font-size: 16px;
      border-radius: var(--radius);
      cursor: pointer;
      overflow: hidden;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Shimmer effect on hover */
    .controls button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 75%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
      transform: skewX(-25deg);
      transition: left 0.7s ease-in-out;
    }

    .controls button:hover::before {
      left: 125%;
    }

    .controls button:hover {
      background: var(--hover-color);
      border-color: var(--accent-color);
      transform: translateY(-2px);
    }

    .controls button:active {
      transform: translateY(0);
    }

    .controls button.edit {
      color: var(--accent-color);
    }

    .controls button.reset {
      color: var(--accent-color);
    }

    .controls button.delete {
      color: #ff6b6b;
    }

    /* ===== ADD BUTTON ===== */
    .add-btn {
      position: relative;
      background: var(--secondary-bg);
      border: 1px solid var(--outline-color);
      color: var(--accent-color);
      font-size: 32px;
      border-radius: var(--radius);
      cursor: pointer;
      width: 180px;
      height: 224px;
      transition: all 0.3s ease;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Shimmer effect on add button */
    .add-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 75%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
      transform: skewX(-25deg);
      transition: left 0.7s ease-in-out;
    }

    .add-btn:hover::before {
      left: 125%;
    }

    .add-btn:hover {
      background: var(--hover-color);
      border-color: var(--accent-color);
      transform: scale(1.02);
    }

    .add-btn:active {
      transform: scale(0.98);
    }

    /* ===== POPUP EDITOR (Desktop Only) ===== */
    .popup {
      position: absolute;
      background: var(--secondary-bg);
      border: 1px solid var(--accent-color);
      border-radius: var(--radius);
      padding: 16px;
      z-index: 1000;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      min-width: 220px;
    }

    .popup.hidden {
      display: none;
    }

    .popup-fields {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      justify-content: center;
    }

    .popup input {
      width: 55px;
      padding: 8px;
      font-size: 14px;
      text-align: center;
      background: var(--primary-bg);
      color: var(--primary-text);
      border: 1px solid var(--outline-color);
      border-radius: var(--radius);
      outline: none;
      transition: border-color 0.2s ease;
    }

    .popup input:focus {
      border-color: var(--accent-color);
    }

    .popup input::placeholder {
      color: var(--secondary-text);
    }

    .popup-buttons {
      display: flex;
      gap: 8px;
    }

    .popup-buttons button {
      position: relative;
      flex: 1;
      padding: 10px 16px;
      border-radius: var(--radius);
      background: var(--secondary-bg);
      color: var(--primary-text);
      border: 1px solid var(--outline-color);
      cursor: pointer;
      overflow: hidden;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    /* Shimmer effect on popup buttons */
    .popup-buttons button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 75%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
      transform: skewX(-25deg);
      transition: left 0.7s ease-in-out;
    }

    .popup-buttons button:hover::before {
      left: 125%;
    }

    .popup-buttons button:hover {
      background: var(--hover-color);
      border-color: var(--accent-color);
    }

    .popup-buttons button#popup-save {
      color: var(--accent-color);
    }

    .popup-buttons button#popup-cancel {
      color: #ff6b6b;
    }

    /* ===== NATIVE TIME INPUT (Mobile) ===== */
    .native-time-input {
      display: none;
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* ===== MOBILE OPTIMIZATION ===== */
    @media (max-width: 768px) {
      body {
        padding: 16px 12px;
      }

      .timer-row {
        gap: 12px;
      }

      .timer, .add-btn {
        width: calc(50% - 6px);
        min-width: 150px;
      }

      .add-btn {
        height: 200px;
      }

      .circle-container {
        width: 100px;
        height: 100px;
      }

      .time-display {
        font-size: 18px;
      }

      .title {
        font-size: 13px;
      }

      .controls button {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      .timer, .add-btn {
        width: 100%;
        max-width: 300px;
      }

      .popup {
        left: 50% !important;
        transform: translateX(-50%);
      }
    }

    /* ===== ACCESSIBILITY ===== */
    button:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(135, 169, 255, 0.3);
    }

    /* Hide audio element */
    audio {
      display: none;
    }
  </style>
</head>
<body>
  <!-- ===== MAIN CONTAINER ===== -->
  <div class="container">
    <div id="rows-container"></div>
  </div>

  <!-- ===== ALARM AUDIO ===== -->
  <audio id="alarm-sound" src="https://contactherovibes.wordpress.com/wp-content/uploads/2025/06/new-notification-09-352705.mp3" preload="auto"></audio>

  <!-- ===== POPUP EDITOR (Desktop) ===== -->
  <div id="popup" class="popup hidden">
    <div class="popup-fields">
      <input type="number" id="popup-hours" min="0" max="23" placeholder="HH" />
      <input type="number" id="popup-minutes" min="0" max="59" placeholder="MM" />
      <input type="number" id="popup-seconds" min="0" max="59" placeholder="SS" />
    </div>
    <div class="popup-buttons">
      <button id="popup-save">✓ Save</button>
      <button id="popup-cancel">✕ Cancel</button>
    </div>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const defaultTimes = [5, 10, 30, 60, 120]; // Default timer durations in minutes
    const maxPerRow = 6; // Maximum timers per row
    let timers = []; // Array to store all timer objects

    // ===== DOM ELEMENTS =====
    const rowsContainer = document.getElementById('rows-container');
    const popup = document.getElementById('popup');
    const hInput = document.getElementById('popup-hours');
    const mInput = document.getElementById('popup-minutes');
    const sInput = document.getElementById('popup-seconds');
    const popupSave = document.getElementById('popup-save');
    const popupCancel = document.getElementById('popup-cancel');
    let currentEditing = null;

    // ===== MOBILE DETECTION =====
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    }

    // ===== URL MANAGEMENT =====
    function parseURLTimers() {
      const params = new URLSearchParams(window.location.search);
      const timersParam = params.get('timers');
      if (timersParam) {
        try {
          return JSON.parse(decodeURIComponent(timersParam));
        } catch (e) {
          console.error('Failed to parse URL timers:', e);
        }
      }
      return null;
    }

    function updateURL() {
      const timerData = timers.map(t => ({
        label: t.label,
        seconds: t.originalSeconds
      }));
      const encoded = encodeURIComponent(JSON.stringify(timerData));
      const newURL = `${window.location.pathname}?timers=${encoded}`;
      window.history.replaceState({}, '', newURL);
    }

    // ===== COLOR CALCULATION BASED ON PERCENTAGE =====
    function getRingColor(percentage) {
      if (percentage > 0.5) {
        // Blue to Yellow gradient (100% to 50%)
        const factor = (percentage - 0.5) * 2; // 0 to 1
        const r = Math.round(135 + (255 - 135) * (1 - factor));
        const g = Math.round(169 + (215 - 169) * (1 - factor));
        const b = Math.round(255 * factor);
        return `rgb(${r}, ${g}, ${b})`;
      } else if (percentage > 0.2) {
        // Yellow to Red gradient (50% to 20%)
        const factor = (percentage - 0.2) / 0.3; // 0 to 1
        const r = 255;
        const g = Math.round(215 * factor);
        const b = 0;
        return `rgb(${r}, ${g}, ${b})`;
      } else {
        // Red (below 20%)
        return '#FF4444';
      }
    }

    // ===== CREATE TIMER FUNCTION =====
    function createTimer(minutes = 5, label = "Timer") {
      const timer = {
        label,
        originalSeconds: minutes * 60,
        remainingSeconds: minutes * 60,
        interval: null,
        element: null,
        isRunning: false,
        hasStarted: false
      };

      // Create timer wrapper element
      const wrapper = document.createElement('div');
      wrapper.className = 'timer';

      // Build timer HTML structure
      wrapper.innerHTML = `
        <div class="title" contenteditable="true">${label}</div>
        <div class="circle-container">
          <svg class="progress-ring" width="120" height="120">
            <circle class="ring-bg" r="54" cx="60" cy="60" />
            <circle class="ring" r="54" cx="60" cy="60" />
          </svg>
          <div class="time-display">00:00</div>
        </div>
        <div class="controls">
          <button class="edit" title="Edit Time" aria-label="Edit Timer">✎</button>
          <button class="reset" title="Reset Timer" aria-label="Reset Timer">↻</button>
          <button class="delete" title="Delete Timer" aria-label="Delete Timer">✕</button>
        </div>
        <input type="time" class="native-time-input" step="1" />
      `;

      // Get ring element and set up progress circle
      const ring = wrapper.querySelector('.ring');
      const radius = 54;
      const circumference = 2 * Math.PI * radius;
      ring.style.strokeDasharray = circumference;
      
      const display = wrapper.querySelector('.time-display');
      const title = wrapper.querySelector('.title');
      const nativeInput = wrapper.querySelector('.native-time-input');

      // ===== DISPLAY UPDATE FUNCTION =====
      function updateDisplay() {
        const total = timer.remainingSeconds;
        const hrs = Math.floor(total / 3600);
        const min = Math.floor((total % 3600) / 60);
        const sec = total % 60;

        if (hrs > 0) {
          display.textContent = `${hrs}:${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        } else {
          display.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }
      }

      // ===== RING UPDATE FUNCTION =====
      function updateRing() {
        const progress = timer.remainingSeconds / timer.originalSeconds;
        const offset = circumference - (progress * circumference);
        ring.style.strokeDashoffset = offset;
        
        // Update ring color based on percentage
        ring.style.stroke = getRingColor(progress);
      }

      // ===== RESET FUNCTION =====
      function resetToOriginal() {
        timer.remainingSeconds = timer.originalSeconds;
        timer.hasStarted = false;
        updateDisplay();
        updateRing();
      }

      // ===== TICK FUNCTION (runs every second) =====
      function tick() {
        if (timer.remainingSeconds > 0) {
          timer.remainingSeconds--;
          updateDisplay();
          updateRing();
        } else {
          // Timer finished - STOP, don't loop
          clearInterval(timer.interval);
          timer.interval = null;
          timer.isRunning = false;
          
          // Play alarm sound
          const alarm = document.getElementById('alarm-sound');
          alarm.play().catch(e => console.log('Audio play failed:', e));
          
          // Do NOT reset automatically - let user manually reset
        }
      }

      // ===== CIRCLE CLICK (Start/Pause) =====
      wrapper.querySelector('.circle-container').addEventListener('click', () => {
        if (timer.interval) {
          // Pause timer
          clearInterval(timer.interval);
          timer.interval = null;
          timer.isRunning = false;
        } else {
          // Start timer
          if (!timer.hasStarted) {
            // First time starting - add pulse animation
            ring.classList.add('pulse');
            setTimeout(() => ring.classList.remove('pulse'), 600);
            timer.hasStarted = true;
          }
          
          timer.interval = setInterval(tick, 1000);
          timer.isRunning = true;
        }
      });

      // ===== EDIT BUTTON =====
      wrapper.querySelector('.edit').addEventListener('click', (e) => {
        if (isMobile()) {
          // Use native time picker on mobile
          const hrs = Math.floor(timer.originalSeconds / 3600);
          const min = Math.floor((timer.originalSeconds % 3600) / 60);
          const sec = timer.originalSeconds % 60;
          
          // Set current value
          nativeInput.value = `${hrs.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
          
          // Trigger native picker
          nativeInput.click();
          nativeInput.focus();
        } else {
          // Use custom popup on desktop
          currentEditing = timer;
          const total = timer.originalSeconds;
          hInput.value = Math.floor(total / 3600);
          mInput.value = Math.floor((total % 3600) / 60);
          sInput.value = total % 60;

          // Position popup near the edit button
          const rect = e.target.getBoundingClientRect();
          popup.style.top = `${rect.bottom + window.scrollY + 8}px`;
          popup.style.left = `${rect.left + window.scrollX}px`;
          popup.classList.remove('hidden');
          
          // Focus first input
          setTimeout(() => hInput.focus(), 100);
        }
      });

      // ===== NATIVE TIME INPUT HANDLER (Mobile) =====
      nativeInput.addEventListener('change', (e) => {
        const timeValue = e.target.value; // Format: HH:MM:SS or HH:MM
        if (timeValue) {
          const parts = timeValue.split(':');
          const hrs = parseInt(parts[0] || 0);
          const min = parseInt(parts[1] || 0);
          const sec = parseInt(parts[2] || 0);
          const totalSec = hrs * 3600 + min * 60 + sec;
          
          if (totalSec > 0) {
            timer.originalSeconds = totalSec;
            timer.remainingSeconds = totalSec;
            timer.hasStarted = false;
            
            clearInterval(timer.interval);
            timer.interval = null;
            timer.isRunning = false;
            
            updateDisplay();
            updateRing();
            updateURL();
          }
        }
      });

      // ===== RESET BUTTON =====
      wrapper.querySelector('.reset').addEventListener('click', () => {
        clearInterval(timer.interval);
        timer.interval = null;
        timer.isRunning = false;
        resetToOriginal();
      });

      // ===== DELETE BUTTON =====
      wrapper.querySelector('.delete').addEventListener('click', () => {
        clearInterval(timer.interval);
        wrapper.remove();
        timers = timers.filter(t => t !== timer);
        renderRows();
        updateURL();
      });

      // ===== TITLE EDIT =====
      title.addEventListener('blur', () => {
        timer.label = title.textContent.trim() || "Timer";
        title.textContent = timer.label;
        updateURL();
      });

      // Prevent newlines in title
      title.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          title.blur();
        }
      });

      // Initialize display
      updateDisplay();
      updateRing();

      timer.element = wrapper;
      timers.push(timer);
      renderRows();
      return timer;
    }

    // ===== RENDER ROWS FUNCTION =====
    function renderRows() {
      rowsContainer.innerHTML = '';
      const chunked = chunkArray(timers, maxPerRow);

      chunked.forEach((row) => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'timer-row';
        row.forEach(timer => rowDiv.appendChild(timer.element));

        // Add "+" button if row isn't full
        if (row.length < maxPerRow) {
          const addBtn = document.createElement('button');
          addBtn.className = 'add-btn';
          addBtn.textContent = '+';
          addBtn.setAttribute('aria-label', 'Add New Timer');
          addBtn.onclick = () => {
            createTimer(5);
            updateURL();
          };
          rowDiv.appendChild(addBtn);
        }

        rowsContainer.appendChild(rowDiv);
      });

      // Add new row with "+" button if last row is full
      if (timers.length % maxPerRow === 0 && timers.length < 24) {
        const newRow = document.createElement('div');
        newRow.className = 'timer-row';
        const addBtn = document.createElement('button');
        addBtn.className = 'add-btn';
        addBtn.textContent = '+';
        addBtn.setAttribute('aria-label', 'Add New Timer');
        addBtn.onclick = () => {
          createTimer(5);
          updateURL();
        };
        newRow.appendChild(addBtn);
        rowsContainer.appendChild(newRow);
      }
    }

    // ===== CHUNK ARRAY HELPER =====
    function chunkArray(arr, size) {
      const result = [];
      for (let i = 0; i < arr.length; i += size) {
        result.push(arr.slice(i, i + size));
      }
      return result;
    }

    // ===== POPUP SAVE BUTTON (Desktop) =====
    popupSave.addEventListener('click', () => {
      const h = parseInt(hInput.value || 0);
      const m = parseInt(mInput.value || 0);
      const s = parseInt(sInput.value || 0);
      const totalSec = h * 3600 + m * 60 + s;

      if (!isNaN(totalSec) && totalSec > 0) {
        currentEditing.originalSeconds = totalSec;
        currentEditing.remainingSeconds = totalSec;
        currentEditing.hasStarted = false;

        // Stop timer if running
        clearInterval(currentEditing.interval);
        currentEditing.interval = null;
        currentEditing.isRunning = false;

        // Update display and ring
        const display = currentEditing.element.querySelector('.time-display');
        const ring = currentEditing.element.querySelector('.ring');
        const radius = 54;
        const circumference = 2 * Math.PI * radius;
        ring.style.strokeDasharray = circumference;
        ring.style.strokeDashoffset = 0;

        const hrs = Math.floor(totalSec / 3600);
        const min = Math.floor((totalSec % 3600) / 60);
        const sec = totalSec % 60;

        if (hrs > 0) {
          display.textContent = `${hrs}:${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        } else {
          display.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        // Reset color to blue
        ring.style.stroke = getRingColor(1);
        
        updateURL();
      }

      popup.classList.add('hidden');
      currentEditing = null;
    });

    // ===== POPUP CANCEL BUTTON =====
    popupCancel.addEventListener('click', () => {
      popup.classList.add('hidden');
      currentEditing = null;
    });

    // ===== CLOSE POPUP ON ESCAPE =====
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !popup.classList.contains('hidden')) {
        popup.classList.add('hidden');
        currentEditing = null;
      }
    });

    // ===== INITIALIZE TIMERS =====
    function initializeTimers() {
      const urlTimers = parseURLTimers();
      
      if (urlTimers && urlTimers.length > 0) {
        // Load from URL
        urlTimers.forEach(timerData => {
          createTimer(timerData.seconds / 60, timerData.label);
        });
      } else {
        // Load defaults
        defaultTimes.forEach(min => createTimer(min, `${min}m Timer`));
        updateURL();
      }
    }

    // ===== START APPLICATION =====
    initializeTimers();

    // ===== FOURTHWALL SCROLLBAR FIX =====
    function sendHeight() {
      var height = document.body.scrollHeight;
      window.parent.postMessage({ frameHeight: height }, '*');
    }

    window.onload = sendHeight;
    window.onresize = sendHeight;

    // Also send height when timers are added/removed
    const observer = new MutationObserver(sendHeight);
    observer.observe(rowsContainer, { childList: true, subtree: true });
  </script>
</body>
</html>
